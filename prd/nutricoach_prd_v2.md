**Crit√©rios de Entrada:**
- Onboarding completo funcional
- Gera√ß√£o de planos (dieta + treino)
- Intera√ß√£o via WhatsApp (agregador + IA)
- Consolida√ß√£o noturna b√°sica

**M√©tricas de Sucesso:**
- 80% dos beta testers completam onboarding
- M√©dia de 5+ intera√ß√µes/dia por usu√°rio
- NPS ‚â• 50
- 70% dos usu√°rios registram consumo alimentar diariamente
- 0 bugs cr√≠ticos por 7 dias consecutivos

**Perfil dos Beta Testers:**
- Amigos, familiares e early adopters tech-savvy
- Dispostos a dar feedback detalhado
- Comprometidos com objetivos reais de fitness

### Fase 1: Soft Launch (M√™s 3-4)
**Objetivo:** Escalar para 100-200 usu√°rios pagantes e validar modelo de neg√≥cio

**Funcionalidades Adicionais:**
- Sistema de pagamento (Stripe)
- Relat√≥rios semanais automatizados
- Lembretes inteligentes de hidrata√ß√£o e medi√ß√µes
- Versionamento completo de planos

**Estrat√©gia de Aquisi√ß√£o:**
- An√∫ncios no Instagram/Facebook (p√∫blico frio)
- Parcerias com microinfluenciadores de fitness (5k-50k seguidores)
- Trial gratuito de 7 dias
- Or√ßamento: R$ 10.000 em ads (CAC alvo: R$ 50)

**M√©tricas de Sucesso:**
- Convers√£o trial ‚Üí pago: ‚â• 30%
- Churn mensal: ‚â§ 10%
- CAC/LTV ratio: ‚â§ 1:3
- Tempo m√©dio de resposta da IA: < 3 segundos

### Fase 2: Public Launch (M√™s 5-6)
**Objetivo:** Atingir 500-1.000 usu√°rios ativos e Product-Market Fit

**Funcionalidades Adicionais:**
- Painel web para visualiza√ß√£o de progresso
- Exporta√ß√£o de relat√≥rios em PDF
- Integra√ß√£o com wearables (Garmin, Apple Watch via HealthKit)
- Sistema de gamifica√ß√£o b√°sico (badges, streaks)

**Estrat√©gia de Aquisi√ß√£o:**
- Campanha de lan√ßamento com desconto (50% primeiro m√™s)
- Programa de indica√ß√£o (R$ 30 de desconto para ambos)
- Conte√∫do org√¢nico SEO (blog posts, v√≠deos explicativos)
- Parcerias com academias (trial gratuito para membros)
- Or√ßamento: R$ 50.000 em ads (CAC alvo: R$ 80)

**M√©tricas de Sucesso:**
- MRR: R$ 45.000 - R$ 90.000
- Churn mensal: ‚â§ 8%
- NPS ‚â• 60
- Viralidade (K-factor): ‚â• 0.3

### Fase 3: Escala e B2B2C (M√™s 7-12)
**Objetivo:** 3.000+ usu√°rios B2C e primeiros 10 profissionais B2B

**Funcionalidades B2B:**
- Dashboard profissional para nutricionistas/PTs
- White-label (logo e cores customiz√°veis)
- Gest√£o de m√∫ltiplos clientes
- Aprova√ß√£o de planos antes da IA executar
- Relat√≥rios gerenciais

**Estrat√©gia:**
- Lan√ßar tier "Pro" para profissionais (R$ 297/m√™s + R$ 29/cliente gerenciado)
- Webinars para nutricionistas e personal trainers
- Presen√ßa em eventos de fitness e nutri√ß√£o
- Certifica√ß√£o de profissionais parceiros

## 4.2 Estrat√©gia de Pricing

### B2C (Usu√°rio Final)

**Tier 1: Basic (Lan√ßamento)**
- R$ 89,90/m√™s
- R$ 239,70/trimestre (11% off = R$ 79,90/m√™s)
- R$ 799,90/ano (26% off = R$ 66,66/m√™s)

**Inclui:**
- Planos personalizados de dieta e treino
- Coaching 24/7 via WhatsApp
- Ajustes autom√°ticos semanais
- Relat√≥rios de progresso semanais
- Suporte via chat

**Tier 2: Premium (Futuro - M√™s 9)**
- R$ 149,90/m√™s
- R$ 399,90/trimestre (R$ 133,30/m√™s)
- R$ 1.399,90/ano (R$ 116,66/m√™s)

**Inclui tudo do Basic +**
- Consultas mensais com nutricionista/PT humano (videochamada)
- An√°lise de exames laboratoriais
- Planos de suplementa√ß√£o personalizados
- Integra√ß√£o com wearables
- Prioridade no suporte

### B2B (Profissionais)

**Tier Profissional:**
- R$ 297/m√™s (plataforma base)
- + R$ 29/m√™s por cliente gerenciado
- Sem limite de clientes

**Exemplo de Rentabilidade para o Profissional:**
- Profissional cobra R$ 400/m√™s por cliente
- Custo NutriCoach: R$ 297 + (20 √ó R$ 29) = R$ 877
- Receita: 20 √ó R$ 400 = R$ 8.000
- Lucro l√≠quido: R$ 7.123 (~89% de margem)
- **Vs modelo tradicional:** atender 20 clientes humanamente √© invi√°vel

## 4.3 Proje√ß√µes Financeiras (36 meses)

### Premissas Base

**Custos Vari√°veis por Usu√°rio/M√™s:**
- OpenAI API: R$ 8,00
- WhatsApp API: R$ 4,00
- Supabase: R$ 2,50
- CDN/Storage: R$ 0,50
- **Total CVU:** R$ 15,00

**Custos Fixos Mensais:**
- Infraestrutura base (Supabase Pro): R$ 250
- Ferramentas SaaS (Stripe, analytics): R$ 500
- Marketing: vari√°vel por fase
- Equipe: vari√°vel por fase
- **Total inicial:** ~R$ 750

### Cen√°rio Base (Realista)

| M√™s | Novos Usu√°rios | Total Ativos | Churn | MRR | Custos | Lucro Mensal |
|-----|----------------|--------------|-------|-----|--------|--------------|
| 1-2 | 25 | 25 | 0% | R$ 0 | R$ 750 | -R$ 750 |
| 3 | 50 | 70 | 8% | R$ 5.600 | R$ 11.800 | -R$ 6.200 |
| 6 | 150 | 500 | 8% | R$ 40.000 | R$ 58.250 | -R$ 18.250 |
| 12 | 300 | 2.000 | 7% | R$ 160.000 | R$ 110.750 | R$ 49.250 |
| 24 | 500 | 8.000 | 6% | R$ 640.000 | R$ 260.750 | R$ 379.250 |
| 36 | 800 | 20.000 | 5% | R$ 1.600.000 | R$ 560.750 | R$ 1.039.250 |

### An√°lise de Viabilidade

**Break-even:** M√™s 11 (~1.800 usu√°rios ativos)

**Payback de Aquisi√ß√£o:**
- CAC m√©dio: R$ 80
- LTV (18 meses de reten√ß√£o): R$ 1.440
- LTV/CAC: 18x
- Payback: 1,1 meses

**Unit Economics Saud√°veis:**
- Margem de contribui√ß√£o: 83% (R$ 74,90 de margem por R$ 89,90 de receita)
- Cash flow positivo em opera√ß√£o ap√≥s m√™s 11

---

# Cap√≠tulo 5: Roadmap de Desenvolvimento

## 5.1 Milestone 1: MVP Core (Semanas 1-8)

### Semanas 1-2: Funda√ß√£o
**Backend:**
- [ ] Setup Supabase project
- [ ] Criar schema inicial do banco (alunos, goals, preferences, body_metrics)
- [ ] Setup Edge Functions base
- [ ] Implementar webhook receiver
- [ ] Configurar integra√ß√£o WhatsApp API (sandbox)

**Frontend:**
- [ ] Criar landing page de captura
- [ ] Criar formul√°rio de onboarding web

**Testes:**
- [ ] Webhook recebe mensagens corretamente
- [ ] Dados de onboarding salvos no banco

### Semanas 3-4: Gera√ß√£o de Planos
**Backend:**
- [ ] Implementar l√≥gica de c√°lculo de TDEE e macros
- [ ] Criar prompts para gera√ß√£o de diet_plans
- [ ] Criar prompts para gera√ß√£o de workout_plans
- [ ] Implementar Edge Function: plan_generator
- [ ] Criar tabelas diet_plans e workout_plans

**IA:**
- [ ] Testar e otimizar prompts de gera√ß√£o
- [ ] Validar qualidade dos planos gerados (10 perfis diferentes)
- [ ] Implementar valida√ß√µes de seguran√ßa (ex: n√£o prescrever d√©ficit > 500kcal/dia)

**Testes:**
- [ ] Planos gerados s√£o personalizados e realistas
- [ ] Planos respeitam restri√ß√µes e prefer√™ncias
- [ ] Tempo de gera√ß√£o < 30 segundos

### Semanas 5-6: Agregador e Conversa√ß√£o
**Backend:**
- [ ] Criar tabelas pending_messages e aggregation_jobs
- [ ] Implementar Edge Function: message_aggregator_processor
- [ ] Configurar pg_cron para executar aggregator a cada 5s
- [ ] Implementar l√≥gica de agrega√ß√£o (janela de 10s)
- [ ] Criar tabela dynamic_prompts
- [ ] Implementar gera√ß√£o de prompt din√¢mico do dia

**IA:**
- [ ] Implementar processamento de linguagem natural para:
  - Registro de alimentos
  - Registro de √°gua
  - Registro de treino
  - Perguntas sobre plano
- [ ] Criar prompts de sistema personalizados
- [ ] Implementar c√°lculo nutricional via base TACO

**Testes:**
- [ ] Mensagens fragmentadas s√£o agregadas corretamente
- [ ] IA responde contextualizadamente
- [ ] Registros s√£o extra√≠dos com precis√£o > 90%

### Semanas 7-8: Consolida√ß√£o Noturna
**Backend:**
- [ ] Criar tabelas completions, daily_consumption_history, daily_workout_logs
- [ ] Implementar Edge Function: consolidation_engine
- [ ] Configurar pg_cron para consolida√ß√£o √†s 02:00
- [ ] Implementar l√≥gica de an√°lise e estrutura√ß√£o de dados
- [ ] Implementar atualiza√ß√£o de cargas (workout_plans)
- [ ] Implementar gera√ß√£o de prompt din√¢mico do pr√≥ximo dia

**IA:**
- [ ] Criar prompt de an√°lise di√°ria
- [ ] Validar JSON outputs estruturados
- [ ] Implementar l√≥gica de progress√£o de cargas

**Testes:**
- [ ] Dados s√£o consolidados corretamente
- [ ] Cargas s√£o atualizadas quando apropriado
- [ ] Prompt din√¢mico √© gerado com contexto completo

### Entrega MVP:
- [ ] 5 beta testers testando por 7 dias consecutivos
- [ ] Feedback coletado e bugs cr√≠ticos corrigidos
- [ ] Documenta√ß√£o t√©cnica b√°sica

## 5.2 Milestone 2: Soft Launch (Semanas 9-16)

### Semanas 9-10: Sistema de Medi√ß√µes e Progresso
**Backend:**
- [ ] Implementar detec√ß√£o autom√°tica de medi√ß√µes nas mensagens
- [ ] Criar l√≥gica de c√°lculo de progresso
- [ ] Implementar lembretes de medi√ß√£o baseados em prefer√™ncias
- [ ] Criar Edge Function: measurement_reminder

**Frontend:**
- [ ] Dashboard web b√°sico (visualiza√ß√£o de gr√°ficos de progresso)

**Testes:**
- [ ] Medi√ß√µes s√£o processadas corretamente
- [ ] Lembretes s√£o enviados no dia/hor√°rio corretos
- [ ] C√°lculos de progresso est√£o precisos

### Semanas 11-12: Relat√≥rios Semanais
**Backend:**
- [ ] Criar tabela progress_reports
- [ ] Implementar Edge Function: report_generator
- [ ] Configurar pg_cron para gera√ß√£o semanal
- [ ] Implementar coleta de dados da semana
- [ ] Implementar agendamento de entrega por hor√°rio preferido

**IA:**
- [ ] Criar prompt de an√°lise semanal
- [ ] Validar qualidade dos relat√≥rios (tom motivacional, precis√£o)

**Testes:**
- [ ] Relat√≥rios gerados refletem dados reais
- [ ] Entrega ocorre no hor√°rio preferido
- [ ] Formato √© leg√≠vel e motivacional

### Semanas 13-14: Pagamentos e Billing
**Backend:**
- [ ] Integrar Stripe (checkout, webhooks)
- [ ] Implementar l√≥gica de trial (7 dias)
- [ ] Implementar bloqueio de acesso ap√≥s trial sem pagamento
- [ ] Criar Edge Function: subscription_manager
- [ ] Implementar renova√ß√£o autom√°tica

**Frontend:**
- [ ] P√°gina de checkout
- [ ] P√°gina de gerenciamento de assinatura

**Testes:**
- [ ] Fluxo completo de trial ‚Üí pagamento
- [ ] Webhooks do Stripe processados corretamente
- [ ] Acesso √© bloqueado/liberado conforme status

### Semanas 15-16: Otimiza√ß√£o e Prepara√ß√£o
**Backend:**
- [ ] Implementar caching de prompts din√¢micos
- [ ] Otimizar queries de banco (√≠ndices, explain analyze)
- [ ] Implementar rate limiting
- [ ] Implementar sistema de logs estruturados
- [ ] Setup monitoring (Sentry para erros)

**DevOps:**
- [ ] CI/CD pipeline (GitHub Actions)
- [ ] Ambiente de staging
- [ ] Backups autom√°ticos do banco

**Marketing:**
- [ ] Landing page otimizada para convers√£o
- [ ] V√≠deo explicativo (60s)
- [ ] Setup Facebook Pixel e Google Analytics
- [ ] Criar 5 an√∫ncios para teste A/B

### Entrega Soft Launch:
- [ ] Sistema de pagamento funcional
- [ ] 50 usu√°rios pagantes ativos
- [ ] Churn < 10% no primeiro m√™s
- [ ] Infraestrutura est√°vel (uptime > 99%)

## 5.3 Milestone 3: Public Launch (Semanas 17-24)

### Semanas 17-18: Painel Web
**Frontend:**
- [ ] Dashboard completo (gr√°ficos de peso, ader√™ncia, volume de treino)
- [ ] Visualiza√ß√£o de planos atuais (dieta e treino)
- [ ] Hist√≥rico de medi√ß√µes com fotos
- [ ] Exporta√ß√£o de relat√≥rios em PDF
- [ ] √Årea de configura√ß√µes (prefer√™ncias, dados de conta)

**Backend:**
- [ ] APIs REST para frontend (com autentica√ß√£o)

### Semanas 19-20: Melhorias de Experi√™ncia
**Features:**
- [ ] Typing indicators no WhatsApp
- [ ] Suporte a √°udio (transcri√ß√£o via Whisper API)
- [ ] Suporte a fotos de refei√ß√µes (an√°lise visual b√°sica)
- [ ] Sistema de favoritos (receitas, treinos)
- [ ] Hist√≥rico de conversas (busca)

**IA:**
- [ ] Melhorias nos prompts baseadas em feedback
- [ ] Implementar fallbacks para casos edge
- [ ] Suporte a substitui√ß√µes contextuais

### Semanas 21-22: Gamifica√ß√£o e Engajamento
**Features:**
- [ ] Sistema de badges (conquistas)
- [ ] Streaks (dias consecutivos de ader√™ncia)
- [ ] Desafios semanais
- [ ] Ranking de progresso (opcional, privado)

**Backend:**
- [ ] Tabela achievements
- [ ] L√≥gica de desbloqueio de badges
- [ ] Notifica√ß√µes de conquistas

### Semanas 23-24: Integra√ß√µes
**Features:**
- [ ] Integra√ß√£o HealthKit (Apple Watch)
- [ ] Integra√ß√£o Google Fit
- [ ] Importa√ß√£o de dados de wearables

**Marketing:**
- [ ] Campanha de lan√ßamento
- [ ] Press kit para imprensa tech
- [ ] Programa de indica√ß√£o implementado
- [ ] Parcerias com academias (5 iniciais)

### Entrega Public Launch:
- [ ] 500+ usu√°rios ativos
- [ ] NPS ‚â• 60
- [ ] CAC/LTV saud√°vel (1:3+)
- [ ] M√≠dia org√¢nica (ao menos 3 publica√ß√µes)

## 5.4 Milestone 4: B2B2C e Escala (M√™s 7-12)

### Funcionalidades B2B
- [ ] Dashboard profissional multi-cliente
- [ ] Sistema de aprova√ß√£o de planos
- [ ] White-label b√°sico
- [ ] Relat√≥rios gerenciais
- [ ] API para integra√ß√µes

### Opera√ß√µes
- [ ] Suporte via chat para profissionais
- [ ] Materiais de onboarding para profissionais
- [ ] Certifica√ß√£o de parceiros
- [ ] SLA de uptime (99.9%)

---

# Cap√≠tulo 6: Gest√£o de Riscos e Mitiga√ß√£o

## 6.1 Riscos T√©cnicos

### Risco 1: Instabilidade da API do WhatsApp
**Probabilidade:** M√©dia | **Impacto:** Cr√≠tico

**Mitiga√ß√£o:**
- Implementar retry logic com exponential backoff
- Monitoramento 24/7 com alertas (PagerDuty)
- Fallback: enviar SMS se WhatsApp falhar por > 5 minutos
- Manter comunica√ß√£o com Meta sobre mudan√ßas na API

### Risco 2: Custos de IA Descontrolados
**Probabilidade:** M√©dia | **Impacto:** Alto

**Mitiga√ß√£o:**
- Implementar rate limiting por usu√°rio (m√°ximo 50 mensagens/dia)
- Caching agressivo de prompts din√¢micos
- Usar GPT-3.5-turbo para intera√ß√µes simples
- Monitorar custos diariamente com alertas (> R$ 100/dia)
- Estabelecer budget cap no OpenAI

### Risco 3: Lat√™ncia Alta nas Respostas
**Probabilidade:** Baixa | **Impacto:** M√©dio

**Mitiga√ß√£o:**
- Otimizar tamanho dos prompts (< 2000 tokens)
- Usar streaming de respostas (chunks)
- CDN para assets est√°ticos
- Edge Functions geograficamente distribu√≠das (Supabase)
- Monitorar P95 latency (alerta se > 5s)

### Risco 4: Perda de Dados
**Probabilidade:** Baixa | **Impacto:** Cr√≠tico

**Mitiga√ß√£o:**
- Backups autom√°ticos di√°rios (Supabase)
- Reten√ß√£o de 30 dias de snapshots
- Teste de restore mensal
- Replica√ß√£o em m√∫ltiplas zonas de disponibilidade
- Auditoria completa de mudan√ßas cr√≠ticas

## 6.2 Riscos de Neg√≥cio

### Risco 5: Baixa Convers√£o Trial ‚Üí Pago
**Probabilidade:** M√©dia | **Impacto:** Alto

**Mitiga√ß√£o:**
- Onboarding guiado com checklist de valor
- Email drip campaign durante trial (dias 1, 3, 5, 7)
- Notifica√ß√£o 24h antes do fim do trial
- Oferecer desconto de 20% se converter no √∫ltimo dia
- Analisar cohorts semanalmente para otimizar

### Risco 6: Churn Alto (> 10%/m√™s)
**Probabilidade:** M√©dia | **Impacto:** Cr√≠tico

**Mitiga√ß√£o:**
- Pesquisa de cancelamento (obrigat√≥ria)
- Win-back campaigns (oferecer pausa de assinatura)
- An√°lise de cohorts para identificar padr√µes de churn
- Melhorias de produto baseadas em feedback
- Notifica√ß√µes de progresso para reengajar usu√°rios inativos

### Risco 7: Satura√ß√£o do Mercado
**Probabilidade:** Baixa | **Impacto:** M√©dio

**Mitiga√ß√£o:**
- Diferencia√ß√£o clara (WhatsApp + adapta√ß√£o inteligente)
- Pivot r√°pido para B2B2C se necess√°rio
- Expans√£o geogr√°fica (Am√©rica Latina)
- Parcerias estrat√©gicas com marcas de suplementos
- Constru√ß√£o de moat via dados propriet√°rios

## 6.3 Riscos Regulat√≥rios

### Risco 8: LGPD / Privacidade de Dados
**Probabilidade:** Baixa | **Impacto:** Alto

**Mitiga√ß√£o:**
- Compliance LGPD desde o design
- Termos de uso e pol√≠tica de privacidade claros
- Consentimento expl√≠cito para coleta de dados
- Direito ao esquecimento implementado (soft delete)
- Auditoria anual de seguran√ßa
- N√£o vender dados de terceiros jamais

### Risco 9: Prescri√ß√£o Nutricional sem CRN
**Probabilidade:** Baixa | **Impacto:** Cr√≠tico

**Mitiga√ß√£o:**
- Disclaimers claros: "sugest√µes educacionais, n√£o prescri√ß√£o"
- No tier B2C: apenas orienta√ß√£o geral, n√£o personaliza√ß√£o cl√≠nica
- No tier B2B: profissional assume responsabilidade legal
- Parcerias com nutricionistas registrados para revis√£o
- Seguro de responsabilidade civil

## 6.4 Riscos de Opera√ß√£o

### Risco 10: Suporte ao Cliente Sobrecarregado
**Probabilidade:** Alta | **Impacto:** M√©dio

**Mitiga√ß√£o:**
- Base de conhecimento (FAQ) automatizada
- Chatbot de suporte para perguntas comuns
- Monitorar tickets de suporte e contratar conforme necess√°rio
- Meta: < 24h de tempo de resposta
- Priorizar bugs que afetam m√∫ltiplos usu√°rios

---

# Cap√≠tulo 7: M√©tricas de Sucesso e KPIs

## 7.1 M√©tricas de Produto

### Engajamento
- **DAU/MAU ratio:** > 0.6 (usu√°rios ativos di√°rios/mensais)
- **Mensagens por usu√°rio/dia:** 5-15 (sweet spot)
- **Taxa de conclus√£o de onboarding:** > 80%
- **Dias at√© primeira intera√ß√£o:** < 2 horas

### Reten√ß√£o
- **D1 retention:** > 80%
- **D7 retention:** > 60%
- **D30 retention:** > 40%
- **Churn mensal:** < 8%

### Qualidade
- **Tempo de resposta m√©dio:** < 3 segundos (P95 < 6s)
- **Uptime:** > 99.5%
- **Taxa de erro da IA:** < 2% (mensagens incompreens√≠veis)
- **NPS:** ‚â• 60

## 7.2 M√©tricas de Neg√≥cio

### Aquisi√ß√£o
- **CAC (Customer Acquisition Cost):** < R$ 100
- **CAC Payback Period:** < 2 meses
- **Convers√£o landing page ‚Üí trial:** > 15%
- **Convers√£o trial ‚Üí pago:** > 30%

### Receita
- **MRR (Monthly Recurring Revenue):** crescimento m√™s-a-m√™s
- **ARR (Annual Recurring Revenue):** crescimento ano-a-ano
- **LTV (Lifetime Value):** > R$ 1.200 (15+ meses de reten√ß√£o)
- **LTV/CAC ratio:** > 3:1

### Efici√™ncia
- **Margem de contribui√ß√£o:** > 80%
- **Burn rate:** controlado conforme runway desejado
- **Magic Number:** > 0.75 (efici√™ncia de crescimento)

## 7.3 M√©tricas de Sa√∫de (Outcome)

### Resultados dos Usu√°rios
- **Usu√°rios que atingem meta de peso em 12 semanas:** > 60%
- **Ader√™ncia m√©dia ao plano alimentar:** > 75%
- **Ader√™ncia m√©dia ao treino:** > 80%
- **Usu√°rios que registram progresso semanalmente:** > 70%

### Satisfa√ß√£o
- **NPS por cohort:** > 60
- **Taxa de indica√ß√£o:** > 20% dos usu√°rios ativos
- **Reviews na App Store/Google Play:** > 4.5 estrelas

---

# Cap√≠tulo 8: Equipe e Organiza√ß√£o

## 8.1 Equipe Fase MVP (M√™s 1-3)

### Desenvolvedor Full-Stack (1x)
**Responsabilidades:**
- Implementar backend (Supabase, Edge Functions)
- Integrar WhatsApp API e OpenAI
- Criar landing page e formul√°rio de onboarding
- Setup de infraestrutura e CI/CD

**Perfil:**
- Experi√™ncia com TypeScript/JavaScript
- Conhecimento de PostgreSQL
- Experi√™ncia com APIs REST e webhooks
- Desej√°vel: experi√™ncia com Supabase ou Firebase

### Cientista de Dados / Prompt Engineer (0.5x - consultoria)
**Responsabilidades:**
- Criar e otimizar prompts para IA
- Implementar l√≥gica de c√°lculos nutricionais
- Validar qualidade dos planos gerados
- An√°lise de dados de uso

**Perfil:**
- Experi√™ncia com LLMs (GPT-4)
- Conhecimento de nutri√ß√£o e exerc√≠cio f√≠sico
- Habilidade anal√≠tica

### Product Manager / Founder (1x)
**Responsabilidades:**
- Definir roadmap e prioridades
- Coletar e analisar feedback de beta testers
- Coordenar desenvolvimento
- Marketing inicial

## 8.2 Equipe Fase Soft Launch (M√™s 4-6)

### Adicionar:

**Designer UI/UX (0.5x - freela)**
- Dashboard web
- Otimiza√ß√£o de landing page
- Assets de marketing

**Profissional de Fitness (consultoria pontual)**
- Revisar planos de treino
- Validar progress√µes de carga
- Criar biblioteca de exerc√≠cios

**Nutricionista (consultoria pontual)**
- Revisar planos alimentares
- Validar c√°lculos e substitui√ß√µes
- Compliance regulat√≥rio

## 8.3 Equipe Fase Public Launch (M√™s 7-12)

### Adicionar:

**Desenvolvedor Backend (1x)**
- Suportar escala
- Melhorias de performance
- Novas integra√ß√µes

**Customer Success (1x)**
- Suporte via chat
- Onboarding de novos usu√°rios
- Coleta de feedback

**Growth Marketer (1x)**
- Gest√£o de campanhas pagas
- SEO e conte√∫do org√¢nico
- Parcerias e indica√ß√µes

---

# Cap√≠tulo 9: Considera√ß√µes √âticas e Compliance

## 9.1 Privacidade e Seguran√ßa

### Coleta de Dados
- Coletar apenas dados essenciais para o servi√ßo
- Consentimento expl√≠cito e informado (opt-in)
- Transpar√™ncia sobre uso de dados
- N√£o vender ou compartilhar com terceiros sem consentimento

### Armazenamento
- Encripta√ß√£o em repouso (AES-256)
- Encripta√ß√£o em tr√¢nsito (TLS 1.3)
- Acesso restrito por fun√ß√£o (RBAC)
- Auditoria de acessos a dados sens√≠veis

### Direitos do Usu√°rio (LGPD)
- Acesso aos pr√≥prios dados (exporta√ß√£o)
- Retifica√ß√£o de dados incorretos
- Exclus√£o de dados (direito ao esquecimento)
- Portabilidade de dados
- Resposta em at√© 15 dias

## 9.2 Responsabilidade M√©dica

### Disclaimers Obrigat√≥rios
- "Este servi√ßo fornece orienta√ß√µes educacionais e n√£o substitui acompanhamento m√©dico profissional"
- "Consulte um m√©dico antes de iniciar qualquer programa de exerc√≠cios ou dieta"
- "Em caso de d√∫vidas ou condi√ß√µes m√©dicas, procure um profissional de sa√∫de"

### Limita√ß√µes do Sistema
- N√£o atender menores de 18 anos sem respons√°vel
- Recusar usu√°rios com hist√≥rico de transtornos alimentares (sugerir acompanhamento profissional)
- N√£o prescrever d√©ficits cal√≥ricos extremos (> 500 kcal/dia)
- N√£o sugerir suplementos ou medicamentos

### Emerg√™ncias
- Detectar men√ß√µes a idea√ß√£o suicida, automutila√ß√£o ‚Üí encaminhar para CVV (188)
- Detectar sinais de transtornos alimentares ‚Üí sugerir buscar ajuda profissional

## 9.3 Vi√©s e Inclus√£o

### Diversidade de Corpos
- Planos personalizados para todos os biotipos
- Linguagem neutra e n√£o-discriminat√≥ria
- Evitar padr√µes est√©ticos irreais ou prejudiciais

### Acessibilidade
- Interface acess√≠vel (WCAG 2.1 n√≠vel AA)
- Suporte a leitores de tela
- Alto contraste para daltonismo

---

# Cap√≠tulo 10: Conclus√£o e Pr√≥ximos Passos

## 10.1 Recapitula√ß√£o da Proposta de Valor

O **NutriCoach AI** representa uma evolu√ß√£o fundamental no mercado de fitness digital ao combinar:

1. **Acessibilidade:** Custo 10x menor que personal trainer tradicional
2. **Conveni√™ncia:** Interface familiar (WhatsApp), sem fric√ß√£o de uso
3. **Intelig√™ncia:** Adapta√ß√£o autom√°tica baseada em dados reais de progresso
4. **Escalabilidade:** Modelo B2B2C que potencializa profissionais humanos

Ao resolver os tr√™s pilares de falha dos apps tradicionais (complexidade, estagna√ß√£o, falta de accountability), o NutriCoach AI est√° posicionado para capturar uma fatia significativa do mercado de wellness digital brasileiro.

## 10.2 Vantagens Competitivas Sustent√°veis

1. **Network Effect de Dados:** Quanto mais usu√°rios, melhores os algoritmos de progress√£o
2. **Integra√ß√£o Profunda com WhatsApp:** Dif√≠cil de replicar sem prejudicar UX
3. **Propriedade Intelectual:** Prompts e l√≥gica de coaching propriet√°rios
4. **Brand Trust:** Primeiros a estabelecer credibilidade em coaching IA no Brasil
5. **Dual Market:** √önico player com estrat√©gia B2C + B2B2C integrada

## 10.3 Perguntas Cr√≠ticas a Responder (MVP)

Antes de escalar, o MVP deve responder:

### 1. Valida√ß√£o de Problema
- [ ] Usu√°rios realmente abandonam apps tradicionais pela fric√ß√£o?
- [ ] O WhatsApp √© de fato a interface ideal ou apenas conveniente?
- [ ] Qual a frequ√™ncia ideal de intera√ß√£o para manter engajamento?

### 2. Valida√ß√£o de Solu√ß√£o
- [ ] A IA consegue compreender 95%+ das mensagens corretamente?
- [ ] Os planos gerados s√£o de qualidade compar√°vel a profissionais humanos?
- [ ] A adapta√ß√£o autom√°tica √© percebida como valiosa pelos usu√°rios?

### 3. Valida√ß√£o de Modelo de Neg√≥cio
- [ ] R$ 89,90/m√™s √© um pre√ßo justo percebido?
- [ ] Trial de 7 dias √© suficiente para demonstrar valor?
- [ ] Qual a principal obje√ß√£o ao pagamento?

### 4. Valida√ß√£o de Mercado
- [ ] Existe demanda real al√©m do c√≠rculo de early adopters?
- [ ] Qual o perfil de usu√°rio com maior fit?
- [ ] Quais canais de aquisi√ß√£o t√™m melhor ROI?

## 10.4 Crit√©rios de Decis√£o Go/No-Go para Pr√≥ximas Fases

### Go de MVP ‚Üí Soft Launch
**Requer:**
- ‚úÖ NPS > 50 com 20+ beta testers
- ‚úÖ 70%+ dos usu√°rios registram dados diariamente por 14+ dias
- ‚úÖ Taxa de compreens√£o da IA > 90%
- ‚úÖ 0 bugs cr√≠ticos de perda de dados
- ‚úÖ Willingness to pay validado (pesquisa qualitativa)

### Go de Soft Launch ‚Üí Public Launch
**Requer:**
- ‚úÖ Convers√£o trial ‚Üí pago > 25%
- ‚úÖ Churn mensal < 10%
- ‚úÖ CAC recuperado em < 3 meses
- ‚úÖ NPS > 60
- ‚úÖ Infraestrutura est√°vel (uptime > 99%)
- ‚úÖ Unit economics positivos (margem > 70%)

### Go de Public Launch ‚Üí Escala
**Requer:**
- ‚úÖ PMF validado (crescimento org√¢nico > 20% MoM)
- ‚úÖ 500+ usu√°rios ativos pagantes
- ‚úÖ Churn mensal < 8%
- ‚úÖ LTV/CAC > 3:1
- ‚úÖ Runway de 12+ meses ou funding garantido

## 10.5 Plano de Execu√ß√£o Imediato (Pr√≥ximos 30 dias)

### Semana 1: Estrutura√ß√£o
- [ ] **Dia 1-2:** Setup de infraestrutura (Supabase, dom√≠nios, WhatsApp Business API sandbox)
- [ ] **Dia 3-4:** Criar schema inicial do banco + migra√ß√µes
- [ ] **Dia 5-7:** Implementar webhook receiver + valida√ß√£o de alunos

### Semana 2: Onboarding
- [ ] **Dia 8-10:** Criar formul√°rio de onboarding web (sem design fancy, funcional)
- [ ] **Dia 11-12:** Implementar salvamento de dados no banco
- [ ] **Dia 13-14:** Testar fluxo completo de onboarding com 3 perfis diferentes

### Semana 3: Gera√ß√£o de Planos
- [ ] **Dia 15-17:** Desenvolver l√≥gica de c√°lculo de TDEE e macros
- [ ] **Dia 18-20:** Criar prompts de gera√ß√£o de diet_plan e workout_plan
- [ ] **Dia 21:** Testar gera√ß√£o com 10 perfis diversos (valida√ß√£o qualitativa)

### Semana 4: Agregador e IA
- [ ] **Dia 22-24:** Implementar agregador de mensagens (10s window)
- [ ] **Dia 25-26:** Implementar processamento de NLU (registro de alimentos/treino)
- [ ] **Dia 27-28:** Criar dynamic_prompts e integrar com OpenAI
- [ ] **Dia 29-30:** Testar conversa completa com 5 beta testers internos

### Checkpoint Dia 30:
**Deliverables:**
- Sistema funcional end-to-end (onboarding ‚Üí planos ‚Üí conversa)
- 5 beta testers testando ativamente
- Documento de feedback e bugs priorizado
- Decis√£o: continuar para Milestone 1 completo ou pivotar

## 10.6 Investimento Necess√°rio

### Fase MVP (M√™s 1-3)
**Capital Necess√°rio:** R$ 45.000

**Breakdown:**
- Desenvolvimento (1 dev full-stack √ó 3 meses): R$ 30.000
- Consultoria especializada (prompts, nutri√ß√£o): R$ 6.000
- Infraestrutura (Supabase, WhatsApp API, OpenAI): R$ 3.000
- Ferramentas SaaS (Stripe, analytics, design): R$ 2.000
- Marketing/landing page: R$ 2.000
- Reserva operacional (15%): R$ 2.000

### Fase Soft Launch (M√™s 4-6)
**Capital Adicional:** R$ 75.000

**Breakdown:**
- Desenvolvimento (1 dev + freelas): R$ 35.000
- Marketing e aquisi√ß√£o: R$ 15.000
- Design e UX: R$ 8.000
- Infraestrutura (escala): R$ 7.000
- Ferramentas e subscriptions: R$ 5.000
- Reserva operacional: R$ 5.000

### Fase Public Launch (M√™s 7-12)
**Capital Adicional:** R$ 280.000

**Breakdown:**
- Equipe (2 devs + CS + Growth): R$ 180.000
- Marketing e ads: R$ 60.000
- Infraestrutura e tools: R$ 20.000
- Legal e compliance: R$ 10.000
- Reserva operacional: R$ 10.000

**Total 12 meses:** R$ 400.000

**Fonte de Capital Sugerida:**
- Bootstrapping: R$ 45.000 (MVP)
- Pr√©-seed / Angels: R$ 150.000 (Soft Launch validado)
- Seed: R$ 500.000 - R$ 1.000.000 (Public Launch com tra√ß√£o)

## 10.7 Vis√£o de 5 Anos

### Ano 1: Product-Market Fit
- 2.000 usu√°rios B2C ativos
- R$ 180.000 MRR
- Piloto B2B com 10 profissionais
- Break-even operacional

### Ano 2: Escala Nacional
- 10.000 usu√°rios B2C ativos
- R$ 900.000 MRR
- 100 profissionais na plataforma B2B
- Expans√£o para S√£o Paulo, Rio e Sul

### Ano 3: Lideran√ßa de Mercado
- 35.000 usu√°rios B2C ativos
- R$ 3.150.000 MRR
- 500 profissionais B2B
- Reconhecimento de marca nacional
- In√≠cio de expans√£o LATAM (Argentina, M√©xico)

### Ano 4: Plataforma Completa
- 80.000 usu√°rios B2C ativos
- R$ 7.200.000 MRR
- 2.000 profissionais B2B
- Marketplace de profissionais
- Integra√ß√£o com laborat√≥rios (exames)
- Parcerias com marcas de suplementos

### Ano 5: Ecossistema de Wellness
- 150.000 usu√°rios B2C ativos
- R$ 13.500.000 MRR
- 5.000 profissionais B2B
- Presen√ßa em 5 pa√≠ses LATAM
- IPO ou aquisi√ß√£o estrat√©gica (exit potencial R$ 200-500M)

## 10.8 Alternativas de Exit

### Cen√°rio 1: Aquisi√ß√£o Estrat√©gica (Ano 3-4)
**Potenciais Compradores:**
- iFood (diversifica√ß√£o para wellness)
- Gympass / Wellhub (complementar √† oferta de academias)
- Nubank (expans√£o para wellness financeiro + f√≠sico)
- Unilever / Nestl√© (marcas de nutri√ß√£o)

**Valuation Estimado:** R$ 80-150M (5-8x ARR)

### Cen√°rio 2: IPO (Ano 5+)
**Requisitos:**
- ARR > R$ 100M
- Crescimento sustent√°vel > 50% ao ano
- Margens > 40%
- Presen√ßa internacional consolidada

**Valuation Estimado:** R$ 300-600M

### Cen√°rio 3: Crescimento Perp√©tuo (Dividend Company)
- Manter independ√™ncia
- Distribuir lucros aos fundadores/investidores
- Crescimento org√¢nico sustent√°vel
- Foco em rentabilidade sobre crescimento agressivo

## 10.9 Mensagem Final para Investidores

### Por que Investir no NutriCoach AI?

**1. Mercado Massivo e Crescente**
- R$ 12 bilh√µes/ano apenas no Brasil
- 42% dos brasileiros interessados em fitness
- Penetra√ß√£o de smartphones + WhatsApp: 96%

**2. Problema Real e Validado**
- 73% de abandono nos primeiros 3 meses (apps tradicionais)
- Personal trainers invi√°veis para 87% da popula√ß√£o
- Necessidade n√£o-atendida de acompanhamento acess√≠vel

**3. Solu√ß√£o 10x Melhor**
- Interface zero-friction (WhatsApp)
- Custo 10x menor que personal trainer
- Adapta√ß√£o inteligente (√∫nico no mercado)
- Disponibilidade 24/7

**4. Modelo de Neg√≥cio Robusto**
- Receita recorrente (SaaS)
- Unit economics saud√°veis (83% margem)
- CAC recuperado em < 2 meses
- LTV/CAC: 18x

**5. Equipe Executora**
- [Experi√™ncia do founder em X]
- [Advisors com expertise em Y]
- [Track record de execu√ß√£o em Z]

**6. Tra√ß√£o Inicial**
- [X usu√°rios no beta]
- [NPS de Y]
- [Z% de ader√™ncia di√°ria]

**7. Timing Perfeito**
- IA generativa agora vi√°vel comercialmente
- WhatsApp Business API amadurecida
- P√≥s-pandemia: boom de consci√™ncia sobre sa√∫de

**8. Moat Defens√°vel**
- Efeitos de rede via dados de progress√£o
- Integra√ß√£o profunda com WhatsApp (dif√≠cil replicar)
- Brand trust (first mover advantage)

**9. Potencial de Exit**
- M√∫ltiplos players estrat√©gicos interessados
- Mercado aquecido para M&A em healthtech
- Caminho claro para IPO (Ano 5+)

**10. Impacto Social**
- Democratiza√ß√£o do acesso a coaching de qualidade
- Combate √† obesidade e doen√ßas cr√¥nicas
- Empoderamento de profissionais de sa√∫de

---

### O Convite

Estamos buscando **R$ 150.000 em investimento Pr√©-seed** para:
- Validar Product-Market Fit com 100-200 usu√°rios pagantes
- Construir funda√ß√£o tecnol√≥gica escal√°vel
- Testar canais de aquisi√ß√£o e otimizar unit economics

**Em troca:**
- 15-20% de equity (valoriza√ß√£o pr√©-money: R$ 600K - 850K)
- Assento no board
- Transpar√™ncia total (relat√≥rios mensais)
- Alinhamento de longo prazo

**Pr√≥ximos Passos:**
1. Reuni√£o de deep dive (apresenta√ß√£o completa + demo)
2. Due diligence t√©cnica e financeira
3. Termo de investimento (SAFE ou equity direto)
4. Kick-off oficial (in√≠cio do desenvolvimento)

**Cronograma:**
- **Hoje:** Voc√™ l√™ este PRD
- **Pr√≥ximos 7 dias:** Reuni√£o inicial
- **Pr√≥ximos 30 dias:** Due diligence + fechamento
- **Dia 31:** Primeiro commit de c√≥digo

---

## 10.10 Anexos e Materiais Complementares

### Anexo A: Personas Detalhadas

**Persona 1: Mariana, 32 anos - Perda de Peso**
- Gerente de marketing, mora em S√£o Paulo
- J√° tentou 3 apps diferentes, desistiu de todos
- Quer perder 12kg para se sentir melhor
- Renda: R$ 6.000/m√™s
- Obje√ß√£o principal: "J√° tentei antes e n√£o funcionou"
- Como o NutriCoach resolve: Acompanhamento di√°rio + adapta√ß√£o autom√°tica

**Persona 2: Ricardo, 28 anos - Ganho de Massa**
- Analista de sistemas, mora em Curitiba
- Treina h√° 2 anos mas "desorganizado"
- Quer ganhar 8kg de massa muscular
- Renda: R$ 5.500/m√™s
- Obje√ß√£o principal: "N√£o tenho disciplina para seguir plano"
- Como o NutriCoach resolve: Lembretes + progress√£o autom√°tica de cargas

**Persona 3: Dr. Fernando, 45 anos - Nutricionista B2B**
- CRN 12345, atende 15 clientes particulares
- Quer escalar atendimento sem perder qualidade
- Cobra R$ 500/m√™s por cliente
- Obje√ß√£o principal: "IA vai substituir meu trabalho"
- Como o NutriCoach resolve: Ferramenta que potencializa, n√£o substitui

### Anexo B: An√°lise Competitiva Detalhada

| Crit√©rio | NutriCoach AI | MyFitnessPal | Fitbod | Personal Trainer |
|----------|---------------|--------------|--------|------------------|
| **Pre√ßo/m√™s** | R$ 89,90 | R$ 50 | R$ 60 | R$ 800-3.000 |
| **Interface** | WhatsApp | App dedicado | App dedicado | Presencial |
| **Personaliza√ß√£o** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **Adapta√ß√£o** | Di√°ria (auto) | Manual | Semanal (auto) | Semanal |
| **Disponibilidade** | 24/7 | 24/7 | 24/7 | 2-3x/semana |
| **Fric√ß√£o de uso** | Muito baixa | Alta | M√©dia | Baixa |
| **Dieta + Treino** | ‚úÖ Integrado | ‚úÖ Separado | ‚ùå S√≥ treino | ‚úÖ Integrado |
| **Accountability** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |

**Conclus√£o:** NutriCoach AI ocupa o "sweet spot" entre apps gen√©ricos e personal trainer humano.

### Anexo C: Roadmap de Funcionalidades Futuras (Ano 2+)

**Q1 Ano 2:**
- [ ] Suporte a outros idiomas (Espanhol, Ingl√™s)
- [ ] Integra√ß√£o com Telegram e Instagram DM
- [ ] Modo offline (sincroniza√ß√£o posterior)

**Q2 Ano 2:**
- [ ] IA de an√°lise de fotos de refei√ß√µes (vis√£o computacional)
- [ ] Gera√ß√£o autom√°tica de lista de compras
- [ ] Integra√ß√£o com iFood/Rappi (sugest√µes de pedidos)

**Q3 Ano 2:**
- [ ] Marketplace de receitas (usu√°rios compartilham)
- [ ] Desafios comunit√°rios
- [ ] Live coaching sessions (webinars)

**Q4 Ano 2:**
- [ ] An√°lise de exames laboratoriais (integra√ß√£o com labs)
- [ ] Suplementa√ß√£o personalizada (parcerias)
- [ ] Telemedicina (consultas com m√©dicos parceiros)

**Ano 3+:**
- [ ] Wearables pr√≥prios (smartwatch NutriCoach)
- [ ] Centros de avalia√ß√£o f√≠sica (franchising)
- [ ] Linha de alimentos NutriCoach (private label)

### Anexo D: Refer√™ncias e Benchmarks

**Empresas Inspiradoras:**
- **Noom:** US$ 4B valuation, coaching de perda de peso via app + psicologia comportamental
- **Future:** Personal training via app + wearables, US$ 500M+ valuation
- **MyFitnessPal:** Vendido para Under Armour por US$ 475M (2015)
- **Fitbit:** Adquirido pelo Google por US$ 2.1B (2021)
- **Peloton:** IPO US$ 8B valuation (2019), pico US$ 50B (2021)

**Papers Acad√™micos:**
- "Effectiveness of AI-driven health coaching" (Stanford, 2024)
- "Adherence to fitness apps: a systematic review" (JMIR, 2023)
- "WhatsApp for healthcare communication" (Lancet Digital Health, 2023)

**Estudos de Mercado:**
- Global Wellness Institute Report 2024
- Pesquisa Brasileiro e Fitness (Estad√£o, 2024)
- Digital Health Trends Brazil (KPMG, 2024)

---

# Gloss√°rio

**ARR (Annual Recurring Revenue):** Receita recorrente anual  
**CAC (Customer Acquisition Cost):** Custo de aquisi√ß√£o de cliente  
**Churn:** Taxa de cancelamento de assinatura  
**DAU/MAU:** Daily Active Users / Monthly Active Users  
**Edge Function:** Fun√ß√£o serverless executada pr√≥xima ao usu√°rio  
**K-factor:** Coeficiente de viralidade  
**LTV (Lifetime Value):** Valor vital√≠cio do cliente  
**MRR (Monthly Recurring Revenue):** Receita recorrente mensal  
**NPS (Net Promoter Score):** M√©trica de satisfa√ß√£o do cliente  
**PMF (Product-Market Fit):** Adequa√ß√£o produto-mercado  
**SaaS (Software as a Service):** Software como servi√ßo  
**TDEE (Total Daily Energy Expenditure):** Gasto energ√©tico di√°rio total  
**UX (User Experience):** Experi√™ncia do usu√°rio  

---

# Controle de Vers√µes

| Vers√£o | Data | Autor | Mudan√ßas |
|--------|------|-------|----------|
| 1.0 | 09/10/2025 | Equipe Produto | Vers√£o inicial com onboarding e estrutura b√°sica |
| 2.0 | 09/10/2025 | Equipe Produto | Revis√£o completa: versionamento de planos, m√©tricas corporais, relat√≥rios, arquitetura detalhada, roadmap, financeiro |

---

# Aprova√ß√µes

| Stakeholder | Cargo | Status | Data |
|-------------|-------|--------|------|
| [Nome] | CEO / Founder | ‚è≥ Pendente | - |
| [Nome] | CTO | ‚è≥ Pendente | - |
| [Nome] | Investidor Lead | ‚è≥ Pendente | - |

---

**Documento Confidencial**  
¬© 2025 NutriCoach AI. Todos os direitos reservados.  
Este documento cont√©m informa√ß√µes propriet√°rias e confidenciais. Reprodu√ß√£o ou distribui√ß√£o n√£o autorizada √© proibida.

---

# Contato

**Para investidores:**  
[email@nutricoach.ai](mailto:email@nutricoach.ai)

**Para parcerias:**  
[partnerships@nutricoach.ai](mailto:partnerships@nutricoach.ai)

**Para imprensa:**  
[press@nutricoach.ai](mailto:press@nutricoach.ai)

---

**"Transformando o acesso ao coaching de elite, uma mensagem de WhatsApp por vez."**

üöÄ NutriCoach AI - O futuro do fitness est√° na sua m√£o.# Documento de Requisitos do Produto (PRD)

## NutriCoach AI - Plataforma de Coaching de Fitness e Nutri√ß√£o

**Vers√£o:** 2.0  
**Data:** 9 de Outubro de 2025  
**Status:** Fase de Planejamento e Arquitetura  
**Classifica√ß√£o:** Confidencial

---

# Sum√°rio Executivo

## Vis√£o Geral

O **NutriCoach AI** √© uma plataforma revolucion√°ria de coaching de fitness e nutri√ß√£o que opera inteiramente dentro do WhatsApp, transformando a experi√™ncia de acompanhamento personalizado atrav√©s de intelig√™ncia artificial. Diferentemente dos aplicativos tradicionais de sa√∫de, o NutriCoach elimina barreiras de ado√ß√£o ao se integrar perfeitamente ao aplicativo de mensagens mais utilizado no mundo, com mais de 2 bilh√µes de usu√°rios ativos.

## O Problema

A ind√∫stria de fitness e bem-estar enfrenta uma taxa de abandono de **73% nos primeiros 3 meses** (estudo Global Wellness Institute, 2024). Os principais motivos s√£o:

1. **Complexidade de Uso:** Aplicativos tradicionais exigem que o usu√°rio navegue por m√∫ltiplas telas, registre dados manualmente em formul√°rios complexos e mantenha disciplina de uso di√°rio.

2. **Falta de Personaliza√ß√£o Real:** Planos gen√©ricos que n√£o se adaptam ao progresso individual, levando √† estagna√ß√£o e desmotiva√ß√£o.

3. **Aus√™ncia de Accountability:** Sem acompanhamento humano frequente, usu√°rios perdem o senso de responsabilidade e comprometimento.

4. **Custo Proibitivo:** Personal trainers e nutricionistas cobram entre R$ 800 e R$ 3.000/m√™s, inviabilizando o acesso para 87% da popula√ß√£o que deseja acompanhamento profissional.

## Nossa Solu√ß√£o

O NutriCoach AI resolve esses problemas atrav√©s de tr√™s pilares fundamentais:

### 1. **Zero Fric√ß√£o de Uso**
- Interface conversacional no WhatsApp (nenhum app adicional para baixar)
- Registro de dados via mensagens simples (ex: "comi 1 banana", "treino supino 50kg 3x10")
- Respostas instant√¢neas 24/7

### 2. **Adapta√ß√£o Inteligente e Cont√≠nua**
- Planos de dieta e treino que evoluem automaticamente baseados em performance
- An√°lise di√°ria de ader√™ncia e progress√£o de cargas
- Ajustes proativos antes que o usu√°rio estagne

### 3. **Acompanhamento Proativo**
- Lembretes inteligentes de hidrata√ß√£o e refei√ß√µes
- Relat√≥rios semanais de progresso com an√°lise qualitativa
- Motiva√ß√£o personalizada baseada em objetivos e conquistas

## Potencial de Mercado

**Mercado Endere√ß√°vel Total (TAM):**
- Brasil: 120 milh√µes de usu√°rios de WhatsApp
- P√∫blico interessado em fitness: 42% (50 milh√µes)
- TAM: R$ 12 bilh√µes/ano

**Mercado Endere√ß√°vel Vi√°vel (SAM):**
- P√∫blico disposto a pagar por coaching digital: 15% (7,5 milh√µes)
- SAM: R$ 1,8 bilh√µes/ano

**Mercado Obt√≠vel Vi√°vel (SOM - Anos 1-3):**
- Meta de penetra√ß√£o: 0,5% nos primeiros 3 anos (37.500 usu√°rios)
- SOM: R$ 9 milh√µes/ano

## Modelo de Neg√≥cio

**Fase Atual (B2C):**
- Assinatura mensal: R$ 89,90
- Assinatura trimestral: R$ 239,70 (R$ 79,90/m√™s - 11% desconto)
- Assinatura anual: R$ 799,90 (R$ 66,66/m√™s - 26% desconto)

**Fase Futura (B2B2C):**
- Licenciamento para nutricionistas e personal trainers
- Modelo SaaS com pricing por cliente gerenciado
- White-label para academias e cl√≠nicas

## Diferenciais Competitivos

| Aspecto | Apps Tradicionais | Personal Trainer | NutriCoach AI |
|---------|-------------------|------------------|---------------|
| **Custo mensal** | R$ 30-60 | R$ 800-3.000 | R$ 89,90 |
| **Disponibilidade** | Ass√≠ncrono | 2-3x/semana | 24/7 |
| **Adapta√ß√£o do plano** | Manual | Semanal | Di√°ria |
| **Fric√ß√£o de uso** | Alta | Baixa | Muito Baixa |
| **Personaliza√ß√£o** | Baixa | Alta | Alta |
| **Escalabilidade** | N/A | Baixa (15-30 clientes) | Ilimitada |

---

# Cap√≠tulo 1: An√°lise de Mercado e Posicionamento

## 1.1 Contexto e Oportunidade

### Tend√™ncias Macrosc√≥picas

**Crescimento do Mercado de Wellness Digital:**
- Mercado global de fitness digital: US$ 27,4 bilh√µes (2024) ‚Üí US$ 59,6 bilh√µes (2030)
- CAGR de 13,8% nos pr√≥ximos 6 anos
- Brasil √© o 2¬∫ maior mercado de academias do mundo (34.000+ unidades)

**Ado√ß√£o de IA em Sa√∫de:**
- 67% dos brasileiros confiam em recomenda√ß√µes de IA para sa√∫de e fitness
- Mercado de IA em healthcare crescendo 38% ao ano

**Predomin√¢ncia do WhatsApp:**
- 96% dos smartphones brasileiros t√™m WhatsApp instalado
- Tempo m√©dio de uso: 38 minutos/dia
- Principal canal de comunica√ß√£o para 78% dos brasileiros

### An√°lise Competitiva

**Concorrentes Diretos:**

1. **MyFitnessPal / Lose It!**
   - For√ßas: Base estabelecida, banco de dados alimentar robusto
   - Fraquezas: Interface complexa, falta de adapta√ß√£o inteligente, experi√™ncia fragmentada
   - Posicionamento: App tradicional de contagem de calorias

2. **Strongr Fastr / Fitbod**
   - For√ßas: Algoritmos de progress√£o de treino
   - Fraquezas: Apenas treino (sem nutri√ß√£o integrada), requer app dedicado
   - Posicionamento: Foco em planejamento de treino

3. **Nutricionistas/PTs Humanos via WhatsApp**
   - For√ßas: Relacionamento humano, expertise profissional
   - Fraquezas: Custo alto, disponibilidade limitada, n√£o escala
   - Posicionamento: Servi√ßo premium personalizado

**Nosso Posicionamento:**
> "O personal trainer de elite acess√≠vel para todos, dispon√≠vel 24/7 no seu bolso"

Ocupamos o espa√ßo entre apps gen√©ricos (baixo custo, baixa personaliza√ß√£o) e acompanhamento humano (alto custo, alta personaliza√ß√£o), oferecendo personaliza√ß√£o pr√≥xima ao humano com custo pr√≥ximo aos apps.

## 1.2 Perfil do Cliente Ideal (ICP)

### Segmento Prim√°rio

**Demogr√°fico:**
- Idade: 25-45 anos
- Renda: R$ 3.000 - R$ 15.000/m√™s (classe B e C+)
- Ocupa√ß√£o: Profissionais urbanos, empreendedores, pais/m√£es
- Localiza√ß√£o: √Åreas metropolitanas (SP, RJ, BH, Curitiba, Porto Alegre)

**Psicogr√°fico:**
- Valorizam efici√™ncia e conveni√™ncia
- Orientados a resultados, mas lutam com consist√™ncia
- Confort√°veis com tecnologia
- Buscam estrutura e orienta√ß√£o (n√£o querem "descobrir sozinhos")
- Dispostos a investir em sa√∫de, mas sens√≠veis a pre√ßo

**Comportamental:**
- J√° tentaram academias ou apps de fitness (com sucesso limitado)
- Usu√°rios ativos de WhatsApp (checam 20+ vezes/dia)
- Consomem conte√∫do de fitness no Instagram/YouTube
- Objetivos claros: perda de gordura (60%) ou ganho de massa (40%)

### Jornada do Cliente

**Fase 1: Conscientiza√ß√£o**
- Frustra√ß√µes com m√©todos atuais ou falta de resultados
- Busca por solu√ß√µes convenientes e acess√≠veis
- Descoberta via: an√∫ncios no Instagram/Facebook, indica√ß√£o de amigos, conte√∫do org√¢nico

**Fase 2: Considera√ß√£o**
- Avalia√ß√£o da proposta de valor (custo vs benef√≠cio)
- Compara√ß√£o com personal trainer (muito caro) e apps tradicionais (muito gen√©ricos)
- D√∫vida principal: "A IA realmente vai me entender?"

**Fase 3: Decis√£o**
- Trial de 7 dias gratuito remove barreira de entrada
- Onboarding guiado demonstra personaliza√ß√£o
- Primeiras intera√ß√µes constroem confian√ßa

**Fase 4: Reten√ß√£o**
- Ciclo de feedback positivo: uso ‚Üí resultados ‚Üí motiva√ß√£o ‚Üí mais uso
- Relat√≥rios semanais refor√ßam progresso
- Comunidade (futura) cria senso de pertencimento

---

# Cap√≠tulo 2: Produto e Funcionalidades

## 2.1 Vis√£o do Produto

O NutriCoach AI √© um **sistema inteligente de coaching adaptativo** que simula a aten√ß√£o e expertise de um personal trainer de elite atrav√©s de tr√™s capacidades fundamentais:

1. **Planejamento Personalizado:** Cria√ß√£o de planos de dieta e treino baseados em perfil individual, objetivos e restri√ß√µes
2. **Monitoramento Cont√≠nuo:** Acompanhamento em tempo real de ader√™ncia, performance e progresso
3. **Adapta√ß√£o Inteligente:** Ajuste autom√°tico de planos baseado em an√°lise de dados e feedback

## 2.2 Jornada do Usu√°rio Completa

### Fase 0: Pr√©-Onboarding (Aquisi√ß√£o)

**Landing Page de Convers√£o:**
- Proposta de valor clara: "Seu personal trainer AI no WhatsApp por R$ 89,90/m√™s"
- Demonstra√ß√£o em v√≠deo (45 segundos)
- Social proof: depoimentos e resultados de beta testers
- CTA: "Iniciar Trial Gratuito de 7 Dias"

**Formul√°rio de Captura:**
- Nome completo
- WhatsApp (validado)
- Email (backup)
- Como conheceu (tracking de canal)

### Fase 1: Onboarding Estruturado (Dia 1)

**Objetivo:** Coletar dados suficientes para gerar plano personalizado de alta qualidade

**Plataforma:** Formul√°rio web responsivo (melhor UX para entrada de dados extensos)

**Estrutura da Anamnese:**

```markdown
## SE√á√ÉO 1: DADOS BIOM√âTRICOS
- Idade, sexo biol√≥gico
- Peso atual, altura
- Circunfer√™ncias (pesco√ßo, cintura, quadril)
- Percentual de gordura (se souber)
- Fotos (opcional, para refer√™ncia)

## SE√á√ÉO 2: HIST√ìRICO E CONTEXTO
- Experi√™ncia pr√©via com treino (iniciante/intermedi√°rio/avan√ßado)
- Hist√≥rico de les√µes ou restri√ß√µes f√≠sicas
- Condi√ß√µes m√©dicas relevantes (diabetes, hipertens√£o, etc.)
- Medica√ß√µes em uso

## SE√á√ÉO 3: OBJETIVOS E METAS
- Objetivo prim√°rio (perda de gordura / ganho de massa / recomposi√ß√£o)
- Meta de peso/composi√ß√£o corporal
- Prazo desejado (realista)
- Motiva√ß√£o principal (ex: casamento, sa√∫de, autoestima)

## SE√á√ÉO 4: CONTEXTO DE TREINO
- Local de treino (academia / casa)
- Equipamentos dispon√≠veis (lista de checkboxes)
- Frequ√™ncia semanal desejada (3-6x/semana)
- Tempo dispon√≠vel por sess√£o (30-90 min)
- Exerc√≠cios que n√£o gosta ou evita

## SE√á√ÉO 5: CONTEXTO ALIMENTAR
- Restri√ß√µes alimentares (vegetariano, intoler√¢ncias, alergias)
- Alimentos que n√£o gosta (m√≠nimo 5)
- Alimentos favoritos (m√≠nimo 5)
- Disposi√ß√£o para preparar comida (alta/m√©dia/baixa)
- Or√ßamento alimentar mensal
- N√∫mero de refei√ß√µes/dia preferido (3-6)

## SE√á√ÉO 6: ROTINA E PREFER√äNCIAS
- Hor√°rio de acordar / dormir
- Hor√°rios preferenciais para treinar
- Dias da semana preferenciais para medir progresso
- Hor√°rio preferido para receber relat√≥rios
- Frequ√™ncia desejada de notifica√ß√µes (baixa/m√©dia/alta)
```

**Output do Onboarding:**
- Registro completo na tabela `alunos`
- Registro em `goals` (objetivo principal)
- Registro em `preferences` (todas as prefer√™ncias)
- Medi√ß√£o inicial em `body_metrics`

### Fase 2: Gera√ß√£o do Plano Inicial (Processamento Backend)

**Processo Automatizado (5-10 minutos):**

1. **An√°lise de Perfil (IA):**
   - C√°lculo de TDEE (Total Daily Energy Expenditure)
   - Defini√ß√£o de d√©ficit/super√°vit cal√≥rico baseado em objetivo
   - C√°lculo de macronutrientes (prote√≠na, carboidratos, gorduras)
   - Defini√ß√£o de meta de hidrata√ß√£o

2. **Gera√ß√£o do Plano Alimentar (IA + Regras):**
   - Distribui√ß√£o de macros por refei√ß√£o
   - Sele√ß√£o de alimentos baseada em prefer√™ncias
   - Evitar alimentos n√£o-gostados
   - Respeitar restri√ß√µes alimentares
   - Varia√ß√µes para cada dia da semana
   - Op√ß√µes de substitui√ß√µes por grupo alimentar

3. **Gera√ß√£o do Programa de Treino (IA + Ci√™ncia do Exerc√≠cio):**
   - Sele√ß√£o de split (divis√£o muscular) adequado
   - Escolha de exerc√≠cios baseada em equipamentos e prefer√™ncias
   - Volume e intensidade apropriados para n√≠vel de experi√™ncia
   - Progress√£o de cargas (come√ßando conservador)
   - Evitar exerc√≠cios problem√°ticos (les√µes/restri√ß√µes)

4. **Persist√™ncia no Banco:**
   - Inser√ß√£o em `diet_plans` (version 1, active)
   - Inser√ß√£o em `workout_plans` (version 1, active)
   - Gera√ß√£o do primeiro `dynamic_prompt`

**Notifica√ß√£o ao Usu√°rio via WhatsApp:**
```
üéâ Seu plano personalizado est√° pronto!

üìã RESUMO DO SEU PLANO:
‚Ä¢ Meta di√°ria: 2.200 kcal (d√©ficit de 300 kcal)
‚Ä¢ Prote√≠nas: 180g | Carbos: 220g | Gorduras: 60g
‚Ä¢ √Ågua: 3 litros/dia

üí™ TREINO: Hipertrofia 4x/semana
‚Ä¢ Seg: Peito e Tr√≠ceps
‚Ä¢ Ter: Pernas
‚Ä¢ Qui: Costas e B√≠ceps
‚Ä¢ Sex: Ombros e Abd√¥men

üöÄ COMO USAR:
‚Ä¢ Me pergunte sobre suas refei√ß√µes
‚Ä¢ Registre o que comeu: "comi 200g de frango"
‚Ä¢ Registre seus treinos: "treino supino 50kg 3x12"
‚Ä¢ Me consulte sempre que tiver d√∫vidas!

Vamos come√ßar? O que voc√™ vai comer no caf√© da manh√£ hoje? ‚òï
```

### Fase 3: Uso Di√°rio (Core Experience)

#### 3.1 Consultas e Orienta√ß√£o

**Casos de Uso Comuns:**

**Exemplo 1: Planejamento de Refei√ß√£o**
```
üë§ Usu√°rio: "O que eu como no almo√ßo hoje?"

ü§ñ NutriCoach: "Hoje no seu almo√ßo est√° planejado:

üçΩÔ∏è ALMO√áO (620 kcal):
‚Ä¢ 150g de frango grelhado (248 kcal)
‚Ä¢ 200g de batata doce (172 kcal)
‚Ä¢ 100g de br√≥colis cozido (35 kcal)
‚Ä¢ 1 colher de azeite (120 kcal)
‚Ä¢ Salada verde √† vontade

Isso te dar√°:
‚Ä¢ 45g de prote√≠na
‚Ä¢ 65g de carboidrato
‚Ä¢ 8g de gordura

Consegue fazer essa refei√ß√£o? Se quiser trocar algo, √© s√≥ pedir! üòä"
```

**Exemplo 2: Substitui√ß√£o de Alimento**
```
üë§ Usu√°rio: "N√£o tenho br√≥colis. Posso trocar?"

ü§ñ NutriCoach: "Claro! Aqui est√£o boas op√ß√µes para substituir o br√≥colis (100g, ~35 kcal):

‚úÖ MESMAS CALORIAS E BENEF√çCIOS:
‚Ä¢ Couve-flor cozida (100g) - 25 kcal
‚Ä¢ Abobrinha grelhada (120g) - 35 kcal
‚Ä¢ Espinafre refogado (100g) - 30 kcal

Todas s√£o ricas em fibras e vitaminas. Qual prefere?"
```

**Exemplo 3: D√∫vida sobre Treino**
```
üë§ Usu√°rio: "N√£o entendi o exerc√≠cio crucifixo inclinado"

ü§ñ NutriCoach: "O crucifixo inclinado √© √≥timo para peito superior! üí™

üìñ COMO FAZER:
1. Deite em banco inclinado (30-45¬∞)
2. Segure halteres acima do peito, bra√ßos estendidos
3. Des√ßa os halteres em arco para os lados
4. Cotovelos levemente flexionados (n√£o trave)
5. Des√ßa at√© sentir alongamento no peito
6. Volte contraindo o peito (abra√ßando)

‚ö†Ô∏è CUIDADOS:
‚Ä¢ N√£o des√ßa al√©m do n√≠vel dos ombros
‚Ä¢ Mantenha esc√°pulas retra√≠das
‚Ä¢ Controle o movimento (sem balan√ßo)

Quer que eu envie um v√≠deo de refer√™ncia?"
```

#### 3.2 Registro de Consumo Alimentar

**Formato Flex√≠vel (Processamento de Linguagem Natural):**

O usu√°rio pode registrar de m√∫ltiplas formas:

```
‚úÖ "comi 1 banana"
‚úÖ "almocei 200g de frango com batata doce"
‚úÖ "cafe da manha: 3 ovos mexidos, 2 fatias pao integral, 1 copo leite"
‚úÖ "/comi 1 scoop whey"
```

**Processamento Backend:**

1. **Extra√ß√£o de Entidades (IA):**
   - Identificar alimentos
   - Identificar quantidades
   - Identificar refei√ß√£o (se mencionada)

2. **C√°lculo Nutricional:**
   - Consulta a base de dados alimentar (TACO/USDA)
   - C√°lculo de macros e calorias
   - Agrega√ß√£o com consumo pr√©vio do dia

3. **Atualiza√ß√£o de Estado:**
   - Inser√ß√£o na tabela `completions` (hist√≥rico do dia)
   - Atualiza√ß√£o de totalizadores tempor√°rios

4. **Feedback ao Usu√°rio:**
```
‚úÖ Registrado: 200g de frango grelhado + 150g de batata doce

üìä TOTAIS DE HOJE (at√© agora):
‚Ä¢ 1.420 / 2.200 kcal (64%)
‚Ä¢ Prote√≠na: 98g / 180g ‚úÖ
‚Ä¢ Carbos: 145g / 220g
‚Ä¢ Gorduras: 28g / 60g

Faltam ~780 kcal para sua meta. Continue assim! üí™
```

#### 3.3 Registro de Treino

**Formato Simplificado:**

```
‚úÖ "treino supino 50kg 3x12"
‚úÖ "supino 50kg 3x12, 52.5kg 1x10"
‚úÖ "leg press 100kg 4x15"
```

**Processamento:**

1. **Extra√ß√£o de Dados:**
   - Exerc√≠cio realizado
   - Carga(s) utilizada(s)
   - S√©ries e repeti√ß√µes

2. **Compara√ß√£o com Plano:**
   - Verificar se a carga est√° acima/abaixo/igual ao planejado
   - Identificar progress√£o ou regress√£o

3. **Feedback Imediato:**
```
üí™ Supino registrado!

üìà COMPARA√á√ÉO:
‚Ä¢ Planejado: 50kg 4x8-12
‚Ä¢ Realizado: 50kg 3x12, 52.5kg 1x10

üéâ √ìtimo! Voc√™ conseguiu aumentar a carga na √∫ltima s√©rie! Na pr√≥xima sess√£o vamos tentar 52.5kg desde a primeira s√©rie.

Volume total hoje: 3.150kg (√≥timo!)
```

4. **Persist√™ncia:**
   - Salvar em `completions` (transit√≥rio)
   - Ser√° consolidado em `daily_workout_logs` √† noite

#### 3.4 Registro de Hidrata√ß√£o

**Comandos R√°pidos:**
```
‚úÖ "agua 500"
‚úÖ "bebi 300ml"
‚úÖ "/agua 250"
```

**Sistema de Lembretes Inteligentes:**

Se o sistema detectar que √†s 14h o usu√°rio bebeu apenas 800ml (meta: 3.000ml/dia), ele envia proativamente:

```
üíß Lembrete de Hidrata√ß√£o!

Voc√™ bebeu apenas 800ml hoje. Para atingir sua meta de 3L, precisa de mais 2.2L at√© o fim do dia.

Que tal beber um copo agora? üòä

Meta recomendada at√© 18h: 2.0L
```

### Fase 4: Ciclo Noturno de Consolida√ß√£o

**Hor√°rio:** 02:00 AM (hor√°rio de menor atividade)

**Processo Automatizado para CADA aluno:**

#### 4.1 Coleta de Dados Transit√≥rios

```sql
-- Buscar todas as intera√ß√µes do dia
SELECT history 
FROM completions 
WHERE aluno_id = $1 
  AND created_at >= CURRENT_DATE 
  AND created_at < CURRENT_DATE + INTERVAL '1 day'
ORDER BY created_at;
```

#### 4.2 An√°lise e Estrutura√ß√£o (IA)

**Prompt para OpenAI:**
```
Voc√™ √© um analista de dados de fitness e nutri√ß√£o. Analise o hist√≥rico de conversas de hoje e extraia as seguintes informa√ß√µes em formato JSON estruturado:

HIST√ìRICO DO DIA:
{conversas_do_dia}

PLANO ALIMENTAR DO DIA:
{diet_plan_do_dia}

PLANO DE TREINO DO DIA:
{workout_plan_do_dia}

EXTRAIA E CALCULE:

1. CONSUMO ALIMENTAR:
   - Lista de todos os alimentos consumidos com quantidades
   - Total de calorias
   - Total de macronutrientes (prote√≠na, carboidrato, gordura)
   - Total de √°gua consumida

2. ADER√äNCIA ALIMENTAR:
   - Compara√ß√£o com metas do plano
   - Percentual de ader√™ncia (0-100%)
   - D√©ficit ou super√°vit cal√≥rico

3. TREINO REALIZADO:
   - Lista de exerc√≠cios executados
   - S√©ries, repeti√ß√µes e cargas de cada
   - Volume total de treino (sets √ó reps √ó carga)

4. ADER√äNCIA AO TREINO:
   - Compara√ß√£o com plano prescrito
   - Exerc√≠cios completados vs planejados
   - Percentual de ader√™ncia

5. AN√ÅLISE DE PERFORMANCE:
   - Exerc√≠cios onde houve progress√£o de carga
   - Exerc√≠cios onde houve regress√£o
   - Exerc√≠cios mantidos

FORMATO DE SA√çDA (JSON):
{
  "consumo": {
    "alimentos": [...],
    "totais": {"calorias": X, "proteina": X, "carboidrato": X, "gordura": X},
    "agua_ml": X
  },
  "aderencia_alimentar": {
    "percentual": X,
    "deficit_superavit_cal": X
  },
  "treino": {
    "exercicios": [...],
    "volume_total_kg": X
  },
  "aderencia_treino": {
    "percentual": X
  },
  "performance": {
    "progressoes": [...],
    "regressoes": [...],
    "mantidos": [...]
  }
}
```

#### 4.3 Persist√™ncia em Tabelas Hist√≥ricas

```javascript
const analysisResult = await callOpenAI(prompt);

// Salvar consumo alimentar
await supabase.from('daily_consumption_history').insert({
  aluno_id: aluno.id,
  data_registro: today,
  meta_calorias: dietPlan.meta_diaria_geral.calorias,
  consumo_calorias: analysisResult.consumo.totais.calorias,
  meta_proteina: dietPlan.meta_diaria_geral.proteinas,
  consumo_proteina: analysisResult.consumo.totais.proteina,
  meta_agua_ml: dietPlan.meta_diaria_geral.agua_ml,
  consumo_agua_ml: analysisResult.consumo.agua_ml,
  deficit_superavit_cal: analysisResult.aderencia_alimentar.deficit_superavit_cal,
  aderencia_percentual: analysisResult.aderencia_alimentar.percentual,
  alimentos_consumidos: analysisResult.consumo.alimentos
});

// Salvar treino realizado
if (analysisResult.treino.exercicios.length > 0) {
  await supabase.from('daily_workout_logs').insert({
    aluno_id: aluno.id,
    data_treino: today,
    treino_realizado: analysisResult.treino,
    volume_total_kg: analysisResult.treino.volume_total_kg,
    aderencia_percentual: analysisResult.aderencia_treino.percentual
  });
}
```

#### 4.4 Atualiza√ß√£o Inteligente de Planos

**L√≥gica de Progress√£o de Carga:**

```javascript
// Se o aluno completou TODAS as s√©ries e reps planejadas com boa forma
if (analysisResult.performance.progressoes.length > 0) {
  
  for (const exercicio of analysisResult.performance.progressoes) {
    // Buscar carga atual no plano
    const currentLoad = getCurrentLoad(workoutPlan, exercicio.nome);
    
    // Calcular novo incremento (2.5-5kg para membros superiores, 5-10kg para inferiores)
    const increment = exercicio.muscle_group === 'legs' ? 5 : 2.5;
    const newLoad = currentLoad + increment;
    
    // Atualizar no plano
    await updateExerciseLoad(workoutPlan.id, exercicio.nome, newLoad);
  }
  
  // Criar nova vers√£o do plano
  await createNewWorkoutPlanVersion(aluno.id, updatedPlan);
}
```

**L√≥gica de Ajuste Nutricional (Semanal):**

```javascript
// A cada 7 dias, analisar tend√™ncia de peso
if (daysSinceLastDietAdjustment >= 7) {
  const weightTrend = await analyzeWeightTrend(aluno.id, 7);
  
  // Se objetivo √© perda de gordura mas peso n√£o mudou
  if (goal.type === 'weight_loss' && weightTrend.change === 0) {
    // Reduzir 100-200 kcal
    await adjustDailyCalories(dietPlan.id, -150);
    
  // Se objetivo √© ganho de massa mas peso n√£o mudou
  } else if (goal.type === 'muscle_gain' && weightTrend.change === 0) {
    // Aumentar 100-200 kcal
    await adjustDailyCalories(dietPlan.id, +150);
  }
  
  // Criar nova vers√£o do plano
  await createNewDietPlanVersion(aluno.id, adjustedPlan);
}
```

#### 4.5 Gera√ß√£o do Prompt Din√¢mico do Pr√≥ximo Dia

```javascript
const newPrompt = `
# CONTEXTO DO ALUNO: ${aluno.nome}

Data: ${tomorrow}
Dia da semana: ${getDayOfWeek(tomorrow)}

## OBJETIVOS ATIVOS
${JSON.stringify(goals, null, 2)}

## PLANO ALIMENTAR DE HOJE
${JSON.stringify(dietPlan.plano_semanal[dayOfWeek], null, 2)}

Meta di√°ria: ${dietPlan.meta_diaria_geral.calorias} kcal
Prote√≠na: ${dietPlan.meta_diaria_geral.proteinas}g
√Ågua: ${dietPlan.meta_diaria_geral.agua_ml}ml

## TREINO DE HOJE
${workoutPlan.divisao_semanal[dayOfWeek] ? JSON.stringify(workoutPlan.divisao_semanal[dayOfWeek]) : 'Dia de descanso'}

## PREFER√äNCIAS
N√£o gosta de: ${preferences.disliked_foods.join(', ')}
Adora: ${preferences.favorite_foods.join(', ')}
Evita exerc√≠cios: ${preferences.disliked_exercises.join(', ')}
Restri√ß√µes f√≠sicas: ${JSON.stringify(preferences.injuries_limitations)}

## RESUMO DE ONTEM
Ader√™ncia alimentar: ${yesterdayStats.diet_adherence}%
Ader√™ncia ao treino: ${yesterdayStats.workout_adherence}%
${yesterdayStats.highlights}

## INSTRU√á√ïES DE COMPORTAMENTO
Voc√™ √© o personal trainer e nutricionista do aluno. Seja:
- Motivacional mas realista
- Educativo mas n√£o prolixo
- Proativo em identificar padr√µes e sugerir melhorias
- Sempre considerando as prefer√™ncias e restri√ß√µes do aluno
- Flex√≠vel para substitui√ß√µes, mas mantendo o aluno no caminho das metas

Quando o aluno registrar consumo ou treino, sempre forne√ßa feedback construtivo e contextualizado.
`;

await supabase.from('dynamic_prompts').insert({
  aluno_id: aluno.id,
  prompt_content: newPrompt,
  created_at: tomorrow
});
```

#### 4.6 Limpeza de Dados Transit√≥rios

```javascript
// Marcar completion como consolidado (N√ÉO deletar)
await supabase
  .from('completions')
  .update({ 
    consolidated: true,
    consolidated_at: new Date()
  })
  .eq('aluno_id', aluno.id)
  .gte('created_at', today)
  .lt('created_at', tomorrow);
```

### Fase 5: Sistema de Relat√≥rios e Progresso

#### 5.1 Coleta Autom√°tica de Medi√ß√µes

**Trigger Baseado em Prefer√™ncias:**

```javascript
// Executado diariamente √†s 08:00
async function sendMeasurementReminders() {
  const today = getDayOfWeek();
  
  // Buscar alunos que medem neste dia da semana
  const alunos = await supabase
    .from('alunos')
    .select('id, nome, whatsapp_number, preferences(*)')
    .eq('preferences.measurement_day', today);
  
  for (const aluno of alunos) {
    // Verificar √∫ltima medi√ß√£o
    const lastMetric = await supabase
      .from('body_metrics')
      .select('measurement_date')
      .eq('aluno_id', aluno.id)
      .order('measurement_date', { desc: true })
      .limit(1)
      .single();
    
    // Se j√° mediu hoje, pular
    if (lastMetric && isSameDay(lastMetric.measurement_date, new Date())) {
      continue;
    }
    
    // Calcular dias desde √∫ltima medi√ß√£o
    const daysSince = differenceInDays(new Date(), lastMetric?.measurement_date || aluno.created_at);
    
    await sendWhatsAppMessage(aluno.whatsapp_number, `
üéØ Bom dia, ${aluno.nome}!

Hoje √© seu dia de atualizar as medidas! üìè

${daysSince >= 7 ? `J√° se passaram ${daysSince} dias desde sua √∫ltima medi√ß√£o. ` : ''}

Por favor, me envie:
‚úÖ Peso atual (obrigat√≥rio)
‚úÖ % Gordura (se tiver balan√ßa de bioimped√¢ncia)
‚úÖ Medidas corporais (opcional mas recomendado)

üìã EXEMPLO:
"Peso: 76.3kg
Gordura: 17.5%
Cintura: 84cm
Bra√ßo direito: 37cm
Coxa: 57cm"

Assim consigo te mostrar sua evolu√ß√£o real! üí™
    `);
  }
}
```

**Processamento de Medi√ß√µes Recebidas:**

```javascript
// Dentro do processador principal de mensagens
async function detectAndProcessMeasurement(message, aluno_id) {
  // IA detecta se a mensagem cont√©m medi√ß√µes
  const hasMeasurement = await detectMeasurementIntent(message);
  
  if (hasMeasurement) {
    const parsed = await parseMeasurementData(message);
    
    // Salvar no banco
    const newMetric = await supabase.from('body_metrics').insert({
      aluno_id,
      weight_kg: parsed.weight,
      body_fat_percentage: parsed.bodyFat,
      measurements: parsed.measurements,
      measurement_conditions: {
        time_of_day: getCurrentPeriod(),
        reported_via: 'whatsapp',
        user_notes: parsed.notes
      }
    }).select().single();
    
    // Calcular progresso
    const progress = await calculateProgressSinceLastMeasurement(aluno_id);
    
    return formatMeasurementConfirmation(newMetric, progress);
  }
  
  return null;
}

async function calculateProgressSinceLastMeasurement(aluno_id) {
  const metrics = await supabase
    .from('body_metrics')
    .select('*')
    .eq('aluno_id', aluno_id)
    .order('measurement_date', { desc: true })
    .limit(2);
  
  if (metrics.data.length < 2) {
    return { isFirst: true };
  }
  
  const [current, previous] = metrics.data;
  const daysBetween = differenceInDays(
    new Date(current.measurement_date),
    new Date(previous.measurement_date)
  );
  
  return {
    isFirst: false,
    daysBetween,
    weight_change: current.weight_kg - previous.weight_kg,
    body_fat_change: current.body_fat_percentage - previous.body_fat_percentage,
    measurements_changes: calculateMeasurementDeltas(
      current.measurements,
      previous.measurements
    )
  };
}

function formatMeasurementConfirmation(metric, progress) {
  if (progress.isFirst) {
    return `
‚úÖ Primeira medi√ß√£o registrada!

üìä DADOS INICIAIS:
‚Ä¢ Peso: ${metric.weight_kg}kg
${metric.body_fat_percentage ? `‚Ä¢ Gordura: ${metric.body_fat_percentage}%` : ''}
${formatMeasurements(metric.measurements)}

Vamos usar isso como base para acompanhar sua evolu√ß√£o! üöÄ
    `;
  }
  
  const weightEmoji = progress.weight_change > 0 ? 'üìà' : progress.weight_change < 0 ? 'üìâ' : '‚û°Ô∏è';
  
  return `
‚úÖ Medidas registradas com sucesso!

üìä EVOLU√á√ÉO (√∫ltimos ${progress.daysBetween} dias):

${weightEmoji} PESO: ${formatChange(progress.weight_change)}kg
   Anterior: ${(metric.weight_kg - progress.weight_change).toFixed(1)}kg
   Atual: ${metric.weight_kg}kg

${progress.body_fat_change ? `
üéØ GORDURA: ${formatChange(progress.body_fat_change)}%
   Anterior: ${(metric.body_fat_percentage - progress.body_fat_change).toFixed(1)}%
   Atual: ${metric.body_fat_percentage}%
` : ''}

${formatMeasurementChanges(progress.measurements_changes)}

${generateProgressAnalysis(progress)}

Continue firme! üí™
  `;
}

function generateProgressAnalysis(progress) {
  const goal = getActiveGoal(); // Busca objetivo do aluno
  
  if (goal.type === 'weight_loss') {
    if (progress.weight_change < -0.5) {
      return 'üéâ Excelente! Voc√™ est√° perdendo peso de forma saud√°vel. Continue assim!';
    } else if (progress.weight_change > 0) {
      return '‚ö†Ô∏è Houve um pequeno ganho de peso. Vamos revisar sua ader√™ncia alimentar e ajustar se necess√°rio.';
    } else {
      return '‚ÑπÔ∏è Peso est√°vel. Pode ser reten√ß√£o de l√≠quidos ou ganho de massa muscular. Vamos monitorar.';
    }
  } else if (goal.type === 'muscle_gain') {
    if (progress.weight_change > 0.3 && progress.weight_change < 0.8) {
      return 'üéâ Perfeito! Voc√™ est√° ganhando peso no ritmo ideal para maximizar m√∫sculo e minimizar gordura.';
    } else if (progress.weight_change > 1) {
      return '‚ö†Ô∏è Ganho de peso acelerado. Vamos ajustar as calorias para garantir que seja mais m√∫sculo que gordura.';
    } else {
      return '‚ÑπÔ∏è Ganho lento. Pode ser bom aumentar um pouco as calorias para acelerar os ganhos.';
    }
  }
  
  return '';
}
```

#### 5.2 Gera√ß√£o de Relat√≥rios Semanais

**Processo Automatizado (Domingos √†s 20h):**

```javascript
async function generateWeeklyReports() {
  const sunday = getLastSunday();
  const monday = getPreviousMonday(sunday);
  
  // Buscar alunos que recebem relat√≥rio aos domingos
  const alunos = await supabase
    .from('alunos')
    .select('*, preferences(*), goals(*)')
    .contains('preferences.preferred_feedback_days', ['sunday']);
  
  for (const aluno of alunos) {
    try {
      // Coletar dados da semana
      const weekData = await collectWeekData(aluno.id, monday, sunday);
      
      // Enviar para IA analisar
      const analysis = await analyzeWeeklyProgress(aluno, weekData);
      
      // Salvar relat√≥rio
      const report = await supabase.from('progress_reports').insert({
        aluno_id: aluno.id,
        report_type: 'weekly',
        period_start: monday,
        period_end: sunday,
        ...analysis
      }).select().single();
      
      // Agendar envio no hor√°rio preferido
      await scheduleReportDelivery(aluno, report);
      
    } catch (error) {
      console.error(`Erro ao gerar relat√≥rio para ${aluno.nome}:`, error);
      // Log para retry posterior
    }
  }
}

async function collectWeekData(aluno_id, startDate, endDate) {
  const [consumption, workouts, metrics, goals] = await Promise.all([
    // Dados de consumo alimentar
    supabase
      .from('daily_consumption_history')
      .select('*')
      .eq('aluno_id', aluno_id)
      .gte('data_registro', startDate)
      .lte('data_registro', endDate)
      .order('data_registro'),
    
    // Dados de treino
    supabase
      .from('daily_workout_logs')
      .select('*')
      .eq('aluno_id', aluno_id)
      .gte('data_treino', startDate)
      .lte('data_treino', endDate)
      .order('data_treino'),
    
    // Medi√ß√µes corporais
    supabase
      .from('body_metrics')
      .select('*')
      .eq('aluno_id', aluno_id)
      .gte('measurement_date', startDate)
      .lte('measurement_date', endDate)
      .order('measurement_date'),
    
    // Objetivos ativos
    supabase
      .from('goals')
      .select('*')
      .eq('aluno_id', aluno_id)
      .eq('status', 'active')
  ]);
  
  return {
    consumption: consumption.data,
    workouts: workouts.data,
    metrics: metrics.data,
    goals: goals.data,
    daysInPeriod: differenceInDays(endDate, startDate) + 1
  };
}

async function analyzeWeeklyProgress(aluno, weekData) {
  // Calcular estat√≠sticas
  const stats = {
    // Ader√™ncia alimentar
    diet_days_tracked: weekData.consumption.length,
    diet_adherence_avg: calculateAverage(weekData.consumption, 'aderencia_percentual'),
    calories_avg: calculateAverage(weekData.consumption, 'consumo_calorias'),
    protein_avg: calculateAverage(weekData.consumption, 'consumo_proteina'),
    
    // Ader√™ncia de treino
    workout_days: weekData.workouts.length,
    workout_adherence_avg: calculateAverage(weekData.workouts, 'aderencia_percentual'),
    total_volume: sumField(weekData.workouts, 'volume_total_kg'),
    
    // Mudan√ßas corporais
    weight_change: calculateWeightChange(weekData.metrics),
    body_fat_change: calculateBodyFatChange(weekData.metrics)
  };
  
  // Prompt para IA
  const prompt = `
Voc√™ √© um personal trainer expert analisando o progresso semanal de ${aluno.nome}.

OBJETIVO DO ALUNO:
${JSON.stringify(weekData.goals, null, 2)}

ESTAT√çSTICAS DA SEMANA:
${JSON.stringify(stats, null, 2)}

DADOS DETALHADOS:
Consumo Alimentar: ${JSON.stringify(weekData.consumption, null, 2)}
Treinos Realizados: ${JSON.stringify(weekData.workouts, null, 2)}
Medi√ß√µes: ${JSON.stringify(weekData.metrics, null, 2)}

Gere um relat√≥rio motivacional e estrat√©gico em JSON:

{
  "summary_text": "Texto de 2-3 par√°grafos parabenizando conquistas e contextualizando desafios",
  "strengths": ["Ponto forte 1", "Ponto forte 2", "Ponto forte 3"],
  "areas_to_improve": ["√Årea 1", "√Årea 2"],
  "ai_recommendations": "Texto com 2-3 recomenda√ß√µes pr√°ticas e acion√°veis",
  "achievements": ["Conquista 1", "Conquista 2"],
  "weight_change_kg": X.X,
  "body_fat_change_percentage": X.X,
  "diet_adherence_percentage": XX,
  "workout_adherence_percentage": XX,
  "hydration_adherence_percentage": XX
}

Seja: motivacional, honesto, espec√≠fico, e acion√°vel.
  `;
  
  const response = await openai.chat.completions.create({
    model: 'gpt-4-turbo',
    messages: [{ role: 'user', content: prompt }],
    response_format: { type: 'json_object' },
    temperature: 0.7
  });
  
  return JSON.parse(response.choices[0].message.content);
}

async function scheduleReportDelivery(aluno, report) {
  const deliveryTime = aluno.preferences.preferred_feedback_time;
  
  // Se o hor√°rio j√° passou hoje, agendar para agora
  const now = new Date();
  const [hours, minutes] = deliveryTime.split(':');
  const scheduledTime = new Date();
  scheduledTime.setHours(hours, minutes, 0);
  
  if (scheduledTime < now) {
    // Enviar imediatamente
    await deliverProgressReport(aluno, report);
  } else {
    // Marcar para envio posterior (ser√° enviado pelo cron de entrega)
    await supabase
      .from('progress_reports')
      .update({ 
        scheduled_delivery_at: scheduledTime 
      })
      .eq('id', report.id);
  }
}
```

**Formato do Relat√≥rio Enviado:**

```javascript
async function deliverProgressReport(aluno, report) {
  const message = `
üìä RELAT√ìRIO SEMANAL - ${format(report.period_start, 'dd/MM')} a ${format(report.period_end, 'dd/MM')}

${report.summary_text}

üìà N√öMEROS DA SEMANA:
‚Ä¢ Peso: ${formatChange(report.weight_change_kg)}kg
${report.body_fat_change_percentage ? `‚Ä¢ Gordura: ${formatChange(report.body_fat_change_percentage)}%` : ''}
‚Ä¢ Ader√™ncia Dieta: ${report.diet_adherence_percentage}%
‚Ä¢ Ader√™ncia Treino: ${report.workout_adherence_percentage}%
‚Ä¢ Hidrata√ß√£o: ${report.hydration_adherence_percentage}%

üí™ SEUS PONTOS FORTES:
${report.strengths.map((s, i) => `${i + 1}. ${s}`).join('\n')}

üéØ OPORTUNIDADES DE MELHORIA:
${report.areas_to_improve.map((a, i) => `${i + 1}. ${a}`).join('\n')}

üí° RECOMENDA√á√ïES PARA ESTA SEMANA:
${report.ai_recommendations}

${report.achievements.length > 0 ? `
üèÜ CONQUISTAS DA SEMANA:
${report.achievements.map(a => `‚ú® ${a}`).join('\n')}
` : ''}

Continue assim! Estou aqui para te apoiar. üöÄ
  `;
  
  await sendWhatsAppMessage(aluno.whatsapp_number, message);
  
  // Marcar como enviado
  await supabase
    .from('progress_reports')
    .update({ 
      sent_to_user: true,
      sent_at: new Date()
    })
    .eq('id', report.id);
}
```

---

# Cap√≠tulo 3: Arquitetura T√©cnica

## 3.1 Vis√£o Geral da Stack

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CAMADA DE USU√ÅRIO                     ‚îÇ
‚îÇ                         WhatsApp App                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üï HTTPS
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CAMADA DE INTEGRA√á√ÉO                      ‚îÇ
‚îÇ               WhatsApp Business API (Meta/Twilio)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üï Webhook
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   CAMADA DE APLICA√á√ÉO (Supabase)             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ              Edge Functions (Deno)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ webhook_receiver      ‚Ä¢ message_processor         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ aggregator_processor  ‚Ä¢ consolidation_engine      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ report_generator      ‚Ä¢ notification_dispatcher   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üï
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CAMADA DE DADOS (Supabase)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ            PostgreSQL Database                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Tabelas principais  ‚Ä¢ Tabelas hist√≥ricas          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Tabelas transit√≥rias ‚Ä¢ Tabelas de controle        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ               pg_cron (Scheduler)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Consolida√ß√£o noturna  ‚Ä¢ Relat√≥rios semanais       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Lembretes de medi√ß√£o  ‚Ä¢ Limpeza de dados          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üï
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   CAMADA DE INTELIG√äNCIA                     ‚îÇ
‚îÇ                      OpenAI API (GPT-4)                      ‚îÇ
‚îÇ  ‚Ä¢ Processamento de linguagem  ‚Ä¢ An√°lise de dados           ‚îÇ
‚îÇ  ‚Ä¢ Gera√ß√£o de planos           ‚Ä¢ Relat√≥rios qualitativos    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## 3.2 Tecnologias e Justificativas

### Backend: Supabase

**Escolha Estrat√©gica:**
- **PostgreSQL robusto** com recursos avan√ßados (JSONB, triggers, functions)
- **Edge Functions** para l√≥gica serverless (Deno runtime)
- **pg_cron** nativo para agendamento de tarefas
- **Real-time subscriptions** (futuro: notifica√ß√µes instant√¢neas)
- **Auth** integrado (futuro: painel web para alunos)
- **Storage** para fotos de progresso
- **Custo-efetivo** comparado a AWS/GCP para MVP

**Alternativas Consideradas:**
- Firebase: Inferior para queries complexas e an√°lises
- AWS Lambda + RDS: Maior complexidade operacional e custo inicial
- MongoDB: Perde em queries relacionais e transa√ß√µes ACID

### IA: OpenAI GPT-4

**Escolha Estrat√©gica:**
- **Melhor compreens√£o de contexto** nutricional e fitness
- **Capacidade de racioc√≠nio** para an√°lises qualitativas
- **JSON Mode** nativo para outputs estruturados
- **Function calling** para integra√ß√£o com ferramentas
- **Confiabilidade** e uptime superior

**Controle de Custos:**
- Uso de GPT-4-turbo para an√°lises complexas (~$0.01 por request)
- Uso de GPT-3.5-turbo para intera√ß√µes simples (~$0.002 por request)
- Caching de prompts din√¢micos (redu√ß√£o de 50% nos tokens)
- Estimativa: $0.15-0.30 por usu√°rio/m√™s

### WhatsApp Integration: Meta Business API

**Escolha Estrat√©gica:**
- API oficial da Meta com maior estabilidade
- Suporte a templates de mensagens (onboarding, lembretes)
- Custo previs√≠vel por conversa iniciada
- Webhooks confi√°veis para recebimento

**Modelo de Cobran√ßa:**
- Conversas iniciadas pelo neg√≥cio: $0.05-0.10 (varia por pa√≠s)
- Respostas dentro de 24h: gratuitas
- Otimiza√ß√£o: Consolidar m√∫ltiplas mensagens em uma janela

## 3.3 Esquema Completo do Banco de Dados

### Tabela: `alunos`

```sql
CREATE TABLE alunos (
  -- Identifica√ß√£o
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  email TEXT UNIQUE,
  whatsapp_number TEXT UNIQUE NOT NULL,
  
  -- Dados biom√©tricos b√°sicos (refer√™ncia r√°pida)
  idade INTEGER,
  sexo TEXT CHECK (sexo IN ('masculino', 'feminino')),
  altura_cm NUMERIC,
  
  -- Dados completos do onboarding (backup)
  onboarding_data JSONB,
  
  -- Status da conta
  subscription_status TEXT DEFAULT 'trial', -- 'trial', 'active', 'paused', 'cancelled'
  subscription_tier TEXT DEFAULT 'basic', -- 'basic', 'premium' (futuro)
  trial_ends_at TIMESTAMPTZ,
  subscription_renews_at TIMESTAMPTZ,
  
  -- Configura√ß√µes de agrega√ß√£o
  aggregation_window_seconds INTEGER DEFAULT 10,
  
  -- Flags de controle
  onboarding_completed BOOLEAN DEFAULT false,
  initial_plans_generated BOOLEAN DEFAULT false,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_interaction_at TIMESTAMPTZ,
  
  -- Soft delete
  deleted_at TIMESTAMPTZ
);

-- √çndices
CREATE INDEX idx_alunos_whatsapp ON alunos(whatsapp_number) WHERE deleted_at IS NULL;
CREATE INDEX idx_alunos_subscription ON alunos(subscription_status) WHERE subscription_status = 'active';
CREATE INDEX idx_alunos_trial ON alunos(trial_ends_at) WHERE subscription_status = 'trial';

-- Trigger para updated_at
CREATE TRIGGER update_alunos_updated_at
  BEFORE UPDATE ON alunos
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### Tabela: `goals`

```sql
CREATE TABLE goals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Tipo e classifica√ß√£o
  goal_type TEXT NOT NULL CHECK (goal_type IN (
    'weight_loss',
    'muscle_gain',
    'body_recomp',
    'performance',
    'health'
  )),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN (
    'active',
    'achieved',
    'abandoned',
    'paused'
  )),
  priority_level INTEGER DEFAULT 5 CHECK (priority_level BETWEEN 1 AND 10),
  
  -- Valores alvo
  target_weight_kg NUMERIC,
  target_body_fat_percentage NUMERIC,
  target_muscle_mass_kg NUMERIC,
  target_measurements JSONB, -- {"chest_cm": 100, "waist_cm": 80, ...}
  
  -- Contexto temporal
  started_at DATE NOT NULL DEFAULT CURRENT_DATE,
  deadline DATE,
  achieved_at DATE,
  
  -- Motiva√ß√£o
  motivation_text TEXT,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- Constraint: apenas 1 objetivo ativo por tipo
  UNIQUE(aluno_id, goal_type) WHERE status = 'active'
);

CREATE INDEX idx_goals_aluno_active ON goals(aluno_id, status) WHERE status = 'active';
CREATE INDEX idx_goals_deadline ON goals(deadline) WHERE status = 'active' AND deadline IS NOT NULL;
```

### Tabela: `preferences`

```sql
CREATE TABLE preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE UNIQUE,
  
  -- Prefer√™ncias Alimentares
  dietary_restrictions JSONB DEFAULT '[]', -- ["lactose_intolerant", "vegetarian"]
  disliked_foods JSONB DEFAULT '[]',
  favorite_foods JSONB DEFAULT '[]',
  meal_prep_willingness TEXT DEFAULT 'medium' CHECK (meal_prep_willingness IN ('low', 'medium', 'high')),
  budget_level TEXT DEFAULT 'medium' CHECK (budget_level IN ('low', 'medium', 'high')),
  meals_per_day INTEGER DEFAULT 4 CHECK (meals_per_day BETWEEN 3 AND 6),
  
  -- Prefer√™ncias de Treino
  available_equipment JSONB DEFAULT '[]', -- ["barbell", "dumbbells"]
  disliked_exercises JSONB DEFAULT '[]',
  favorite_exercises JSONB DEFAULT '[]',
  training_location TEXT DEFAULT 'gym' CHECK (training_location IN ('gym', 'home', 'both')),
  training_frequency_per_week INTEGER DEFAULT 4 CHECK (training_frequency_per_week BETWEEN 2 AND 7),
  training_duration_minutes INTEGER DEFAULT 60 CHECK (training_duration_minutes BETWEEN 30 AND 120),
  preferred_training_times JSONB DEFAULT '[]', -- ["morning", "evening"]
  
  -- Restri√ß√µes F√≠sicas
  injuries_limitations JSONB DEFAULT '[]',
  /*
  [
    {
      "body_part": "joelho direito",
      "restriction": "evitar impacto",
      "since": "2024-03-15",
      "severity": "moderate"
    }
  ]
  */
  
  -- Prefer√™ncias de Comunica√ß√£o
  preferred_feedback_days JSONB DEFAULT '["sunday"]', -- Array de dias da semana
  preferred_feedback_time TIME DEFAULT '19:00:00',
  notification_frequency TEXT DEFAULT 'moderate' CHECK (notification_frequency IN ('low', 'moderate', 'high')),
  language_preference TEXT DEFAULT 'pt-BR',
  
  -- Prefer√™ncias de Medi√ß√£o
  measurement_day TEXT DEFAULT 'sunday', -- Dia da semana preferido
  measurement_frequency TEXT DEFAULT 'weekly' CHECK (measurement_frequency IN ('daily', 'weekly', 'biweekly', 'monthly')),
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_preferences_aluno ON preferences(aluno_id);
CREATE INDEX idx_preferences_measurement_day ON preferences(measurement_day);
```

### Tabela: `body_metrics`

```sql
CREATE TABLE body_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Data e tipo
  measurement_date DATE NOT NULL DEFAULT CURRENT_DATE,
  measurement_type TEXT NOT NULL DEFAULT 'regular' CHECK (measurement_type IN (
    'initial',
    'regular',
    'progress_check',
    'final'
  )),
  
  -- Composi√ß√£o Corporal
  weight_kg NUMERIC NOT NULL,
  body_fat_percentage NUMERIC CHECK (body_fat_percentage BETWEEN 3 AND 60),
  muscle_mass_kg NUMERIC,
  visceral_fat_level INTEGER CHECK (visceral_fat_level BETWEEN 1 AND 30),
  bmr_kcal INTEGER, -- Taxa metab√≥lica basal (se balan√ßa fornecer)
  
  -- Medidas Corporais (em cm)
  measurements JSONB,
  /*
  {
    "neck_cm": 38,
    "shoulders_cm": 110,
    "chest_cm": 98,
    "waist_cm": 85,
    "hips_cm": 95,
    "biceps_left_cm": 35,
    "biceps_right_cm": 35.5,
    "forearm_left_cm": 28,
    "forearm_right_cm": 28,
    "thigh_left_cm": 56,
    "thigh_right_cm": 56.5,
    "calf_left_cm": 38,
    "calf_right_cm": 38
  }
  */
  
  -- Contexto da medi√ß√£o
  measurement_conditions JSONB,
  /*
  {
    "time_of_day": "morning",
    "fasted": true,
    "post_workout": false,
    "hydration_status": "normal",
    "menstrual_cycle_phase": "follicular" (para mulheres)
  }
  */
  
  -- Evid√™ncias
  photo_urls JSONB, -- ["https://storage/front.jpg", "https://storage/side.jpg", "https://storage/back.jpg"]
  notes TEXT,
  
  -- BMI Calculado Automaticamente
  bmi NUMERIC GENERATED ALWAYS AS (
    CASE 
      WHEN weight_kg > 0 THEN 
        ROUND(weight_kg / POWER((SELECT altura_cm FROM alunos WHERE id = aluno_id) / 100.0, 2), 1)
      ELSE NULL 
    END
  ) STORED,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_body_metrics_aluno_date ON body_metrics(aluno_id, measurement_date DESC);
CREATE INDEX idx_body_metrics_type ON body_metrics(aluno_id, measurement_type);
```

### Tabela: `diet_plans`

```sql
CREATE TABLE diet_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Versionamento
  version INTEGER NOT NULL DEFAULT 1,
  is_active BOOLEAN DEFAULT true,
  valid_from DATE NOT NULL DEFAULT CURRENT_DATE,
  valid_until DATE, -- NULL para o plano ativo atual
  
  -- Plano completo em JSONB
  plan_details JSONB NOT NULL,
  /*
  {
    "meta_diaria_geral": {
      "calorias": 2200,
      "proteinas": 180,
      "carboidratos": 220,
      "gorduras": 60,
      "fibras": 30,
      "agua_ml": 3000
    },
    "plano_semanal": {
      "segunda-feira": [
        {
          "refeicao": "Caf√© da Manh√£",
          "horario_sugerido": "07:00",
          "descricao": "Omelete de 3 ovos com queijo e tomate + 2 fatias de p√£o integral + 1 banana",
          "alimentos": [
            {"nome": "Ovos", "quantidade": "3 unidades", "calorias": 216, "proteina": 18, "carb": 2, "gordura": 15},
            {"nome": "Queijo minas", "quantidade": "30g", "calorias": 90, "proteina": 6, "carb": 1, "gordura": 7},
            ...
          ],
          "totais": {"calorias": 450, "proteina": 28, "carb": 52, "gordura": 12},
          "substituicoes_sugeridas": {
            "Ovos": ["Clara de ovos (6 unidades)", "Tofu mexido (150g)"],
            "P√£o integral": ["Tapioca (1 unidade)", "Batata doce (100g)"]
          }
        },
        {
          "refeicao": "Lanche da Manh√£",
          ...
        }
      ],
      "ter√ßa-feira": [...],
      ...
    },
    "orientacoes_gerais": [
      "Priorize fontes de prote√≠na magra em todas as refei√ß√µes",
      "Beba √°gua regularmente ao longo do dia",
      "Evite alimentos ultraprocessados"
    ]
  }
  */
  
  -- Raz√£o da cria√ß√£o/atualiza√ß√£o
  created_by TEXT NOT NULL DEFAULT 'ai_generated', -- 'ai_generated', 'ai_adjusted', 'professional_override'
  adjustment_reason TEXT, -- "Estagna√ß√£o de peso por 2 semanas", "Pedido do usu√°rio", etc.
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- Garantir versionamento √∫nico e sequencial
  UNIQUE(aluno_id, version)
);

CREATE INDEX idx_diet_plans_aluno_active ON diet_plans(aluno_id, is_active) WHERE is_active = true;
CREATE INDEX idx_diet_plans_version ON diet_plans(aluno_id, version DESC);
CREATE INDEX idx_diet_plans_dates ON diet_plans(aluno_id, valid_from, valid_until);

-- Trigger para garantir apenas 1 plano ativo por aluno
CREATE OR REPLACE FUNCTION ensure_single_active_diet_plan()
RETURNS TRIGGER AS $
BEGIN
  IF NEW.is_active = true THEN
    -- Desativar todos os outros planos deste aluno
    UPDATE diet_plans 
    SET is_active = false, 
        valid_until = CURRENT_DATE - INTERVAL '1 day'
    WHERE aluno_id = NEW.aluno_id 
      AND id != NEW.id 
      AND is_active = true;
  END IF;
  RETURN NEW;
END;
$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_ensure_single_active_diet_plan
  BEFORE INSERT OR UPDATE ON diet_plans
  FOR EACH ROW
  EXECUTE FUNCTION ensure_single_active_diet_plan();
```

### Tabela: `workout_plans`

```sql
CREATE TABLE workout_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Versionamento
  version INTEGER NOT NULL DEFAULT 1,
  is_active BOOLEAN DEFAULT true,
  valid_from DATE NOT NULL DEFAULT CURRENT_DATE,
  valid_until DATE,
  
  -- Programa completo em JSONB
  plan_details JSONB NOT NULL,
  /*
  {
    "nome_programa": "Hipertrofia Upper/Lower 4x",
    "objetivo": "Ganho de massa muscular",
    "nivel": "intermediario",
    "frequencia_semanal": 4,
    "duracao_estimada_minutos": 60,
    "divisao_semanal": {
      "segunda-feira": {
        "nome_treino": "Upper A - Peito e Costas",
        "foco": "Membros superiores - empurrar e puxar",
        "aquecimento": {
          "descricao": "5 min bike + mobilidade de ombros",
          "duracao_minutos": 5
        },
        "exercicios": [
          {
            "ordem": 1,
            "nome": "Supino Reto com Barra",
            "grupo_muscular": "peito",
            "tipo": "composto",
            "series": 4,
            "repeticoes": "8-12",
            "carga_kg": 50,
            "descanso_segundos": 90,
            "observacoes": "Descer a barra at√© encostar no peito, subir controlado",
            "progressao_sugerida": {
              "metodo": "carga",
              "incremento_kg": 2.5,
              "criterio": "completar 4x12 com boa forma"
            }
          },
          {
            "ordem": 2,
            "nome": "Remada Curvada com Barra",
            "grupo_muscular": "costas",
            "tipo": "composto",
            "series": 4,
            "repeticoes": "8-12",
            "carga_kg": 40,
            "descanso_segundos": 90,
            "observacoes": "Costas retas, puxar barra at√© abd√¥men"
          },
          ...
        ],
        "alongamento": {
          "descricao": "Alongamento de peito, costas e ombros",
          "duracao_minutos": 5
        }
      },
      "ter√ßa-feira": {
        "nome_treino": "Lower A - Pernas Completo",
        ...
      },
      "quarta-feira": {
        "descanso": true,
        "atividade_opcional": "Caminhada leve 30 min ou alongamento"
      },
      "quinta-feira": {
        "nome_treino": "Upper B - Ombros e Bra√ßos",
        ...
      },
      "sexta-feira": {
        "nome_treino": "Lower B - √änfase Posterior",
        ...
      },
      "sabado": {
        "descanso": true
      },
      "domingo": {
        "descanso": true
      }
    },
    "orientacoes_gerais": [
      "Execute todos os exerc√≠cios com boa forma antes de aumentar carga",
      "Se n√£o conseguir completar as repeti√ß√µes m√≠nimas, reduza 5-10% da carga",
      "Registre todas as cargas e repeti√ß√µes para acompanhamento"
    ]
  }
  */
  
  -- Raz√£o da cria√ß√£o/atualiza√ß√£o
  created_by TEXT NOT NULL DEFAULT 'ai_generated',
  adjustment_reason TEXT,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  UNIQUE(aluno_id, version)
);

CREATE INDEX idx_workout_plans_aluno_active ON workout_plans(aluno_id, is_active) WHERE is_active = true;
CREATE INDEX idx_workout_plans_version ON workout_plans(aluno_id, version DESC);

-- Trigger similar ao diet_plans
CREATE TRIGGER trigger_ensure_single_active_workout_plan
  BEFORE INSERT OR UPDATE ON workout_plans
  FOR EACH ROW
  EXECUTE FUNCTION ensure_single_active_diet_plan(); -- Fun√ß√£o gen√©rica reutiliz√°vel
```

### Tabela: `dynamic_prompts`

```sql
CREATE TABLE dynamic_prompts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Data para qual este prompt √© v√°lido
  valid_date DATE NOT NULL DEFAULT CURRENT_DATE,
  
  -- Conte√∫do completo do prompt de sistema
  prompt_content TEXT NOT NULL,
  
  -- Hash para detec√ß√£o de mudan√ßas (otimiza√ß√£o)
  content_hash TEXT GENERATED ALWAYS AS (md5(prompt_content)) STORED,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- Apenas 1 prompt por aluno por dia
  UNIQUE(aluno_id, valid_date)
);

CREATE INDEX idx_dynamic_prompts_aluno_date ON dynamic_prompts(aluno_id, valid_date DESC);
CREATE INDEX idx_dynamic_prompts_today ON dynamic_prompts(valid_date) WHERE valid_date = CURRENT_DATE;
```

### Tabela: `pending_messages`

```sql
CREATE TABLE pending_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Conte√∫do da mensagem
  message_content TEXT NOT NULL,
  message_type TEXT DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'audio', 'document')),
  media_url TEXT, -- Se for m√≠dia
  
  -- Timestamps
  received_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- Status de processamento
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'aggregated', 'processed', 'failed')),
  processed_at TIMESTAMPTZ,
  error_message TEXT,
  
  -- Refer√™ncia ao job de agrega√ß√£o
  aggregation_job_id UUID,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_pending_messages_aluno_status ON pending_messages(aluno_id, status, received_at) 
  WHERE status = 'pending';
CREATE INDEX idx_pending_messages_job ON pending_messages(aggregation_job_id);

-- Auto-limpeza de mensagens processadas antigas
CREATE OR REPLACE FUNCTION cleanup_old_pending_messages()
RETURNS void AS $
BEGIN
  DELETE FROM pending_messages
  WHERE status = 'processed'
    AND processed_at < now() - INTERVAL '7 days';
END;
$ LANGUAGE plpgsql;

SELECT cron.schedule(
  'cleanup-pending-messages',
  '0 4 * * *', -- 04:00 AM diariamente
  $SELECT cleanup_old_pending_messages()$
);
```

### Tabela: `aggregation_jobs`

```sql
CREATE TABLE aggregation_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Agendamento
  execute_at TIMESTAMPTZ NOT NULL,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN (
    'scheduled',
    'processing',
    'completed',
    'failed'
  )),
  
  -- Resultado
  aggregated_message TEXT,
  ai_response TEXT,
  error_message TEXT,
  
  -- Timestamps
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_aggregation_jobs_ready ON aggregation_jobs(execute_at, status) 
  WHERE status = 'scheduled' AND execute_at <= now();
CREATE INDEX idx_aggregation_jobs_aluno ON aggregation_jobs(aluno_id, created_at DESC);

-- Limpeza de jobs antigos
SELECT cron.schedule(
  'cleanup-aggregation-jobs',
  '0 4 * * *',
  $
  DELETE FROM aggregation_jobs
  WHERE status IN ('completed', 'failed')
    AND completed_at < now() - INTERVAL '30 days'
  $
);
```

### Tabela: `completions`

```sql
CREATE TABLE completions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Hist√≥rico da conversa (formato OpenAI)
  history JSONB NOT NULL DEFAULT '[]',
  /*
  [
    {"role": "user", "content": "Comi 1 banana"},
    {"role": "assistant", "content": "Banana registrada! 105 kcal..."}
  ]
  */
  
  -- Metadados da requisi√ß√£o
  model_used TEXT DEFAULT 'gpt-4-turbo',
  tokens_used INTEGER,
  cost_usd NUMERIC(10, 6),
  
  -- Data da conversa
  conversation_date DATE NOT NULL DEFAULT CURRENT_DATE,
  
  -- Status de consolida√ß√£o
  consolidated BOOLEAN DEFAULT false,
  consolidated_at TIMESTAMPTZ,
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_completions_aluno_date ON completions(aluno_id, conversation_date DESC);
CREATE INDEX idx_completions_unconsolidated ON completions(aluno_id, consolidated) 
  WHERE consolidated = false;

-- Pol√≠tica de reten√ß√£o: manter apenas √∫ltimos 90 dias
SELECT cron.schedule(
  'cleanup-old-completions',
  '0 5 * * *', -- 05:00 AM diariamente
  $
  DELETE FROM completions
  WHERE consolidated = true
    AND conversation_date < CURRENT_DATE - INTERVAL '90 days'
  $
);
```

### Tabela: `daily_consumption_history`

```sql
CREATE TABLE daily_consumption_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Data do registro
  data_registro DATE NOT NULL,
  
  -- Metas do dia
  meta_calorias NUMERIC NOT NULL,
  meta_proteina NUMERIC NOT NULL,
  meta_carboidrato NUMERIC NOT NULL,
  meta_gordura NUMERIC NOT NULL,
  meta_agua_ml NUMERIC NOT NULL,
  
  -- Consumo realizado
  consumo_calorias NUMERIC NOT NULL DEFAULT 0,
  consumo_proteina NUMERIC NOT NULL DEFAULT 0,
  consumo_carboidrato NUMERIC NOT NULL DEFAULT 0,
  consumo_gordura NUMERIC NOT NULL DEFAULT 0,
  consumo_agua_ml NUMERIC NOT NULL DEFAULT 0,
  
  -- An√°lise
  deficit_superavit_cal NUMERIC GENERATED ALWAYS AS (consumo_calorias - meta_calorias) STORED,
  aderencia_percentual NUMERIC CHECK (aderencia_percentual BETWEEN 0 AND 100),
  
  -- Detalhamento
  alimentos_consumidos JSONB,
  /*
  [
    {
      "refeicao": "Caf√© da Manh√£",
      "horario": "07:30",
      "alimentos": [
        {"nome": "Banana", "quantidade": "1 unidade", "calorias": 105, "proteina": 1.3, ...}
      ]
    }
  ]
  */
  
  -- Observa√ß√µes
  notas TEXT, -- Observa√ß√µes do usu√°rio ou da IA
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  UNIQUE(aluno_id, data_registro)
);

CREATE INDEX idx_daily_consumption_aluno_date ON daily_consumption_history(aluno_id, data_registro DESC);
CREATE INDEX idx_daily_consumption_aderencia ON daily_consumption_history(aluno_id, aderencia_percentual);

-- View para an√°lise de tend√™ncias
CREATE VIEW consumption_trends AS
SELECT 
  aluno_id,
  DATE_TRUNC('week', data_registro) as week_start,
  AVG(aderencia_percentual) as avg_adherence,
  AVG(consumo_calorias) as avg_calories,
  AVG(consumo_proteina) as avg_protein,
  COUNT(*) as days_tracked
FROM daily_consumption_history
GROUP BY aluno_id, DATE_TRUNC('week', data_registro);
```

### Tabela: `daily_workout_logs`

```sql
CREATE TABLE daily_workout_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Data do treino
  data_treino DATE NOT NULL,
  
  -- Treino realizado
  treino_realizado JSONB NOT NULL,
  /*
  {
    "nome_treino": "Upper A - Peito e Costas",
    "exercicios_feitos": [
      {
        "nome": "Supino Reto",
        "series_realizadas": [
          {"serie": 1, "reps": 12, "carga_kg": 50, "rpe": 7},
          {"serie": 2, "reps": 12, "carga_kg": 50, "rpe": 8},
          {"serie": 3, "reps": 10, "carga_kg": 52.5, "rpe": 9},
          {"serie": 4, "reps": 8, "carga_kg": 52.5, "rpe": 10}
        ],
        "observacoes": "Aumentei a carga nas √∫ltimas 2 s√©ries"
      },
      ...
    ],
    "duracao_minutos": 65,
    "percepcao_esforco_geral": 8
  }
  */
  
  -- M√©tricas calculadas
  volume_total_kg NUMERIC, -- Soma de (s√©ries √ó reps √ó carga) de todos exerc√≠cios
  exercicios_completados INTEGER,
  series_totais INTEGER,
  aderencia_percentual NUMERIC, -- Compara√ß√£o com plano prescrito
  
  -- An√°lise de performance
  progressoes JSONB, -- Exerc√≠cios onde houve melhora
  regressoes JSONB, -- Exerc√≠cios onde houve piora
  
  -- Observa√ß√µes
  notas TEXT,
  
  -- Metadados
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  UNIQUE(aluno_id, data_treino)
);

CREATE INDEX idx_daily_workout_aluno_date ON daily_workout_logs(aluno_id, data_treino DESC);
CREATE INDEX idx_daily_workout_volume ON daily_workout_logs(aluno_id, volume_total_kg DESC);

-- View para an√°lise de progress√£o
CREATE VIEW workout_progression AS
SELECT 
  aluno_id,
  data_treino,
  volume_total_kg,
  LAG(volume_total_kg) OVER (PARTITION BY aluno_id ORDER BY data_treino) as previous_volume,
  volume_total_kg - LAG(volume_total_kg) OVER (PARTITION BY aluno_id ORDER BY data_treino) as volume_change
FROM daily_workout_logs
ORDER BY aluno_id, data_treino DESC;
```

### Tabela: `progress_reports`

```sql
CREATE TABLE progress_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  aluno_id UUID NOT NULL REFERENCES alunos(id) ON DELETE CASCADE,
  
  -- Tipo e per√≠odo
  report_type TEXT NOT NULL CHECK (report_type IN ('weekly', 'monthly', 'custom')),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  
  -- Mudan√ßas corporais
  weight_change_kg NUMERIC,
  body_fat_change_percentage NUMERIC,
  muscle_mass_change_kg NUMERIC,
  measurements_changes JSONB, -- {"chest_cm": +2, "waist_cm": -3}
  
  -- Ader√™ncia e performance
  diet_adherence_percentage NUMERIC CHECK (diet_adherence_percentage BETWEEN 0 AND 100),
  workout_adherence_percentage NUMERIC CHECK (workout_adherence_percentage BETWEEN 0 AND 100),
  hydration_adherence_percentage NUMERIC CHECK (hydration_adherence_percentage BETWEEN 0 AND 100),
  
  -- An√°lise qualitativa (gerada pela IA)
  summary_text TEXT NOT NULL, -- 2-3 par√°grafos motivacionais
  strengths JSONB, -- ["Ponto forte 1", "Ponto forte 2"]
  areas_to_improve JSONB, -- ["√Årea 1", "√Årea 2"]
  ai_recommendations TEXT, -- Sugest√µes pr√°ticas
  
  -- Conquistas
  achievements JSONB, -- ["Primeira vez agachando 100kg", "7 dias seguidos 100% ader√™ncia"]
  
  -- Status de entrega
  scheduled_delivery_at TIMESTAMPTZ,
  sent_to_user BOOLEAN DEFAULT false,
  sent_at TIMESTAMPTZ,
  
  -- Metadados
  generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_progress_reports_aluno ON progress_reports(aluno_id, period_end DESC);
CREATE INDEX idx_progress_reports_pending ON progress_reports(sent_to_user, scheduled_delivery_at) 
  WHERE sent_to_user = false;
CREATE INDEX idx_progress_reports_type ON progress_reports(aluno_id, report_type);
```

### Tabela: `audit_log` (Compliance e Debug)

```sql
CREATE TABLE audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Contexto
  table_name TEXT NOT NULL,
  record_id UUID NOT NULL,
  action TEXT NOT NULL CHECK (action IN ('insert', 'update', 'delete')),
  
  -- Dados
  old_values JSONB,
  new_values JSONB,
  
  -- Autor
  changed_by TEXT, -- 'system', 'ai', 'admin', 'user:uuid'
  
  -- Timestamp
  changed_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_audit_log_table_record ON audit_log(table_name, record_id);
CREATE INDEX idx_audit_log_timestamp ON audit_log(changed_at DESC);

-- Fun√ß√£o gen√©rica de auditoria
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO audit_log (table_name, record_id, action, new_values, changed_by)
    VALUES (TG_TABLE_NAME, NEW.id, 'insert', row_to_json(NEW), current_setting('app.current_user', true));
    RETURN NEW;
  ELSIF TG_OP = 'UPDATE' THEN
    INSERT INTO audit_log (table_name, record_id, action, old_values, new_values, changed_by)
    VALUES (TG_TABLE_NAME, NEW.id, 'update', row_to_json(OLD), row_to_json(NEW), current_setting('app.current_user', true));
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    INSERT INTO audit_log (table_name, record_id, action, old_values, changed_by)
    VALUES (TG_TABLE_NAME, OLD.id, 'delete', row_to_json(OLD), current_setting('app.current_user', true));
    RETURN OLD;
  END IF;
END;
$ LANGUAGE plpgsql;

-- Aplicar auditoria em tabelas cr√≠ticas
CREATE TRIGGER audit_diet_plans
  AFTER INSERT OR UPDATE OR DELETE ON diet_plans
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER audit_workout_plans
  AFTER INSERT OR UPDATE OR DELETE ON workout_plans
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER audit_goals
  AFTER INSERT OR UPDATE OR DELETE ON goals
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

---

## 3.4 Fluxo de Dados Detalhado

### Fluxo 1: Recebimento e Agrega√ß√£o de Mensagens

```mermaid
sequenceDiagram
    participant WA as WhatsApp
    participant GW as Gateway (Meta API)
    participant WH as Webhook Receiver
    participant DB as Supabase DB
    participant AG as Aggregator Processor
    participant AI as OpenAI
    
    WA->>GW: Usu√°rio envia mensagem
    GW->>WH: POST /webhook (message data)
    WH->>DB: SELECT aluno WHERE whatsapp = X
    
    alt Aluno n√£o encontrado
        WH-->>GW: 200 OK (ignored)
    else Aluno encontrado
        WH->>DB: INSERT INTO pending_messages
        WH->>DB: SELECT aggregation_job WHERE aluno_id AND status='scheduled'
        
        alt Job j√° existe
            WH-->>GW: 200 OK (queued)
        else Criar novo job
            WH->>DB: INSERT INTO aggregation_jobs (execute_at = now + 10s)
            WH->>GW: Send typing indicator
            WH-->>GW: 200 OK (queued)
        end
    end
    
    Note over AG: pg_cron executa a cada 5s
    AG->>DB: SELECT jobs WHERE execute_at <= now AND status='scheduled'
    AG->>DB: UPDATE job SET status='processing'
    AG->>DB: SELECT pending_messages WHERE aluno_id AND status='pending'
    AG->>DB: SELECT dynamic_prompt WHERE aluno_id AND valid_date=today
    AG->>DB: SELECT recent completions (context)
    
    AG->>AI: POST /chat/completions (context + aggregated messages)
    AI-->>AG: AI Response
    
    AG->>DB: INSERT INTO completions (history)
    AG->>GW: Send message to WhatsApp
    AG->>DB: UPDATE pending_messages SET status='processed'
    AG->>DB: UPDATE job SET status='completed'
    
    GW->>WA: Entregar resposta ao usu√°rio
```

### Fluxo 2: Consolida√ß√£o Noturna

```mermaid
sequenceDiagram
    participant CR as pg_cron
    participant CE as Consolidation Engine
    participant DB as Supabase DB
    participant AI as OpenAI
    
    Note over CR: 02:00 AM diariamente
    CR->>CE: Trigger consolidation
    
    loop Para cada aluno ativo
        CE->>DB: SELECT completions WHERE date=yesterday AND consolidated=false
        CE->>DB: SELECT diet_plan active
        CE->>DB: SELECT workout_plan active
        
        CE->>AI: Analyze day data (structured extraction)
        AI-->>CE: JSON with nutrition + workout stats
        
        CE->>DB: INSERT INTO daily_consumption_history
        CE->>DB: INSERT INTO daily_workout_logs
        
        alt Performance analysis
            CE->>AI: Analyze workout progression
            AI-->>CE: Progressions and regressions
            
            alt Load progression detected
                CE->>DB: UPDATE workout_plan (new loads)
                CE->>DB: INSERT new workout_plan version
            end
        end
        
        alt Weekly diet check (every 7 days)
            CE->>DB: SELECT body_metrics last 7 days
            CE->>AI: Analyze weight trend vs goal
            AI-->>CE: Adjustment recommendation
            
            alt Adjustment needed
                CE->>DB: UPDATE diet_plan (calories)
                CE->>DB: INSERT new diet_plan version
            end
        end
        
        CE->>CE: Generate next day's dynamic prompt
        CE->>DB: INSERT INTO dynamic_prompts (tomorrow)
        
        CE->>DB: UPDATE completions SET consolidated=true
    end
```

### Fluxo 3: Gera√ß√£o e Entrega de Relat√≥rios

```mermaid
sequenceDiagram
    participant CR as pg_cron
    participant RG as Report Generator
    participant DB as Supabase DB
    participant AI as OpenAI
    participant GW as Gateway
    participant WA as WhatsApp
    
    Note over CR: Domingos 20:00
    CR->>RG: Trigger weekly reports
    
    loop Para cada aluno eleg√≠vel
        RG->>DB: Collect week data (consumption, workouts, metrics)
        RG->>DB: SELECT goals active
        RG->>DB: SELECT preferences
        
        RG->>AI: Analyze progress + generate motivational report
        AI-->>RG: JSON with analysis
        
        RG->>DB: INSERT INTO progress_reports
        
        alt Delivery time check
            RG->>DB: CHECK preferred_feedback_time
            
            alt Time has passed
                RG->>GW: Send report immediately
                GW->>WA: Deliver to user
                RG->>DB: UPDATE report SET sent=true
            else Schedule for later
                RG->>DB: UPDATE report SET scheduled_delivery_at
            end
        end
    end
    
    Note over CR: A cada minuto
    CR->>RG: Check scheduled deliveries
    RG->>DB: SELECT reports WHERE scheduled_delivery_at <= now AND sent=false
    
    loop Para cada relat√≥rio pendente
        RG->>GW: Send report
        GW->>WA: Deliver
        RG->>DB: UPDATE report SET sent=true, sent_at=now
    end
```

---

# Cap√≠tulo 4: Estrat√©gia de Go-to-Market

## 4.1 Fases de Lan√ßamento

### Fase 0: MVP Fechado (M√™s 1-2)
**Objetivo:** Validar hip√≥teses core com 20-30 beta testers

**Crit√©rios de Entrada:**
- Onboarding completo funcional
- Gera√ß√£o de planos (dieta + treino)
- Intera√ß√£o via WhatsApp (agregador + IA)
- Consolida√ß√£o noturna b√°sica

**M√©tricas de Sucesso:**
- 80% dos beta testers completam onboarding
- M√©dia de 5+ intera√ß√µes/dia por usu√°rio
- NPS ‚â• 50